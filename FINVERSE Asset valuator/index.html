<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Finverse Strategic Asset Valuator</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; }
        
        /* Custom Scrollbar */
        .custom-scroll::-webkit-scrollbar { height: 8px; width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f5f9; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .glass-card {
            background: white;
            border: 1px solid #e2e8f0;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }
        
        .tab-active {
            border-bottom: 2px solid #2563eb;
            color: #2563eb;
        }
        .tab-inactive {
            border-bottom: 2px solid transparent;
            color: #64748b;
        }
        .tab-inactive:hover {
            color: #334155;
            border-bottom: 2px solid #cbd5e1;
        }
    </style>
</head>
<body class="text-slate-800">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        // --- Icons (Inline SVGs) ---
        const Icons = {
            Lock: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
            ),
            Unlock: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 9.9-1"></path></svg>
            ),
            Activity: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"></polyline></svg>
            ),
            PlusCircle: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
            ),
            Loader2: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 12a9 9 0 1 1-6.219-8.56"></path></svg>
            ),
            Globe: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><line x1="2" y1="12" x2="22" y2="12"></line><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"></path></svg>
            ),
            LayoutDashboard: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><rect x="3" y="3" width="7" height="9"></rect><rect x="14" y="3" width="7" height="5"></rect><rect x="14" y="12" width="7" height="9"></rect><rect x="3" y="16" width="7" height="5"></rect></svg>
            ),
            Table2: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M9 3H5a2 2 0 0 0-2 2v4m6-6h10a2 2 0 0 1 2 2v4M9 3v18m0 0h10a2 2 0 0 0 2-2V9M9 21H5a2 2 0 0 1-2-2V9m0 0h18"></path></svg>
            ),
            Download: ({ size = 24, className = "" }) => (
                <svg xmlns="http://www.w3.org/2000/svg" width={size} height={size} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
            )
        };

        // --- Constants & Enums ---
        const ASSET_TYPES = [
            { id: 'PPE', label: 'Property, Plant & Equip', monetary: false },
            { id: 'INVESTMENT', label: 'Investment', monetary: false }, 
            { id: 'LOAN', label: 'Loan / Receivable', monetary: true },
            { id: 'CASH', label: 'Cash & Equivalents', monetary: true },
            { id: 'GOODWILL', label: 'Goodwill', monetary: false },
            { id: 'EQUITY', label: 'Equity Instrument', monetary: false }
        ];

        const VALUATION_BASIS_OPTIONS = [
            { id: 'IAS21', label: 'Auto (IAS 21 Default)' },
            { id: 'HISTORICAL', label: 'Historical Spot' },
            { id: 'CLOSING', label: 'Closing Spot' },
            { id: 'AVG_30', label: '30-Day Average' },
            { id: 'MANUAL', label: 'Manual Override' }
        ];

        const CURRENCIES = ["USD", "EUR", "GBP", "JPY", "CNY", "AUD", "SGD", "INR"];

        // --- Helpers ---
        const calculateVolatility = (ratesArray) => {
            if (!ratesArray || ratesArray.length < 2) return 0;
            const mean = ratesArray.reduce((a, b) => a + b, 0) / ratesArray.length;
            const variance = ratesArray.reduce((a, b) => a + Math.pow(b - mean, 2), 0) / ratesArray.length;
            return Math.sqrt(variance) / mean; 
        };

        const getRiskScore = (volatility) => {
            if (volatility < 0.005) return { label: 'Low', color: 'bg-emerald-100 text-emerald-700' };
            if (volatility < 0.015) return { label: 'Medium', color: 'bg-yellow-100 text-yellow-700' };
            return { label: 'High', color: 'bg-red-100 text-red-700' };
        };

        const formatDate = (dateStr) => {
            if (!dateStr) return '-';
            return new Date(dateStr).toLocaleDateString('en-GB', { day: 'numeric', month: 'short', year: 'numeric' });
        };

        // --- Mock Data for Demo ---
        const MOCK_ASSETS = [
            {
                id: 'demo-1',
                entity: 'Finverse USA Inc.',
                country: 'USA',
                assetType: 'LOAN',
                name: 'Intercompany Loan Tranche A',
                purchaseDate: '2023-01-15',
                carryingValueFC: 500000,
                currency: 'USD',
                valuationBasis: 'IAS21',
                monetary: true,
                manualOverrideRate: null,
                treatment: "Closing Rate (IAS 21)",
                rates: {
                    purchaseSpot: 81.50,
                    closingRate: 83.45,
                    avg7: 83.30,
                    avg30: 83.15,
                    volatility: 0.003
                }
            },
            {
                id: 'demo-2',
                entity: 'Finverse GmbH',
                country: 'Germany',
                assetType: 'PPE',
                name: 'Berlin Data Center Equip.',
                purchaseDate: '2022-06-10',
                carryingValueFC: 1200000,
                currency: 'EUR',
                valuationBasis: 'HISTORICAL',
                monetary: false,
                manualOverrideRate: null,
                treatment: "Historical Rate (IAS 21)",
                rates: {
                    purchaseSpot: 85.20,
                    closingRate: 90.10,
                    avg7: 89.95,
                    avg30: 89.50,
                    volatility: 0.008
                }
            },
            {
                id: 'demo-3',
                entity: 'Finverse UK Ltd',
                country: 'UK',
                assetType: 'GOODWILL',
                name: 'Acquisition Goodwill',
                purchaseDate: '2021-11-01',
                carryingValueFC: 750000,
                currency: 'GBP',
                valuationBasis: 'IAS21',
                monetary: false,
                manualOverrideRate: null,
                treatment: "Historical Rate (IAS 21)",
                rates: {
                    purchaseSpot: 102.50,
                    closingRate: 105.80,
                    avg7: 105.60,
                    avg30: 105.20,
                    volatility: 0.012
                }
            },
            {
                id: 'demo-4',
                entity: 'Finverse Japan KK',
                country: 'Japan',
                assetType: 'CASH',
                name: 'Operational Cash Float',
                purchaseDate: '2023-09-01',
                carryingValueFC: 25000000,
                currency: 'JPY',
                valuationBasis: 'CLOSING',
                monetary: true,
                manualOverrideRate: null,
                treatment: "Closing Rate (IAS 21)",
                rates: {
                    purchaseSpot: 0.56,
                    closingRate: 0.54,
                    avg7: 0.545,
                    avg30: 0.55,
                    volatility: 0.018 // High volatility simulation
                }
            },
            {
                id: 'demo-5',
                entity: 'Finverse Pty Ltd',
                country: 'Australia',
                assetType: 'INVESTMENT',
                name: 'Strategic Equity Stake',
                purchaseDate: '2023-03-20',
                carryingValueFC: 300000,
                currency: 'AUD',
                valuationBasis: 'MANUAL',
                manualOverrideRate: 54.00, // Manual Lock
                monetary: false,
                treatment: "Historical Rate (IAS 21)",
                rates: {
                    purchaseSpot: 53.50,
                    closingRate: 54.20,
                    avg7: 54.10,
                    avg30: 53.90,
                    volatility: 0.005
                }
            }
        ];

        // --- API Layer ---
        const fetchFXData = async (base, target, purchaseDate) => {
            try {
                const today = new Date();
                const endDate = today.toISOString().split('T')[0];
                const date30DaysAgo = new Date();
                date30DaysAgo.setDate(today.getDate() - 35);
                const startDate = date30DaysAgo.toISOString().split('T')[0];

                let purchaseSpot = 0;
                try {
                    const histResp = await fetch(`https://api.frankfurter.app/${purchaseDate}?from=${base}&to=${target}`);
                    const histData = await histResp.json();
                    purchaseSpot = histData.rates[target];
                } catch (e) {
                    console.warn("Historical date fetch failed, fallback needed");
                }

                const seriesResp = await fetch(`https://api.frankfurter.app/${startDate}..${endDate}?from=${base}&to=${target}`);
                const seriesData = await seriesResp.json();
                
                const rates = Object.values(seriesData.rates).map(r => r[target]);
                const closingRate = rates[rates.length - 1];
                
                const last7 = rates.slice(-7);
                const avg7 = last7.reduce((a, b) => a + b, 0) / last7.length;
                const last30 = rates.slice(-30);
                const avg30 = last30.reduce((a, b) => a + b, 0) / last30.length;

                const volatility = calculateVolatility(last30);

                return {
                    purchaseSpot: purchaseSpot || closingRate,
                    closingRate,
                    avg7,
                    avg30,
                    volatility
                };
            } catch (error) {
                console.error("FX Service Error:", error);
                return null;
            }
        };

        // --- Extracted Components ---

        const Dashboard = ({ reportingCurrency, dashboardData, reportingDate, isLocked }) => (
            <div className="space-y-6 animate-fadeIn">
                {/* Top KPIs */}
                <div className="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div className="glass-card p-4 rounded-xl border-l-4 border-blue-500">
                        <h3 className="text-xs font-bold text-slate-400 uppercase">Total Asset Value</h3>
                        <div className="text-2xl font-bold text-slate-800 mt-1">
                            {reportingCurrency} {dashboardData.totalValue.toLocaleString(undefined, { maximumFractionDigits: 0 })}
                        </div>
                    </div>
                    <div className="glass-card p-4 rounded-xl border-l-4 border-indigo-500">
                        <h3 className="text-xs font-bold text-slate-400 uppercase">Implied FX Translation Reserve</h3>
                        <div className={`text-2xl font-bold mt-1 ${dashboardData.translationImpact >= 0 ? 'text-emerald-600' : 'text-red-600'}`}>
                            {dashboardData.translationImpact >= 0 ? '+' : ''} 
                            {dashboardData.translationImpact.toLocaleString(undefined, { maximumFractionDigits: 0 })}
                        </div>
                        <p className="text-[10px] text-slate-400 mt-1">Vs Historical Cost Basis</p>
                    </div>
                    <div className="glass-card p-4 rounded-xl border-l-4 border-amber-500">
                        <h3 className="text-xs font-bold text-slate-400 uppercase">High Volatility Assets</h3>
                        <div className="text-2xl font-bold text-slate-800 mt-1">
                            {dashboardData.highRiskCount} <span className="text-sm font-normal text-slate-400">/ {dashboardData.assetCount}</span>
                        </div>
                    </div>
                    <div className="glass-card p-4 rounded-xl border-l-4 border-slate-500">
                        <h3 className="text-xs font-bold text-slate-400 uppercase">Reporting Date</h3>
                        <div className="text-lg font-bold text-slate-800 mt-2 flex items-center justify-between">
                            {formatDate(reportingDate)}
                            {isLocked ? <Icons.Lock size={16} className="text-red-500"/> : <Icons.Unlock size={16} className="text-emerald-500"/>}
                        </div>
                    </div>
                </div>

                {/* Sensitivity Analysis */}
                <div className="glass-card rounded-xl overflow-hidden">
                    <div className="bg-slate-50 px-6 py-4 border-b border-slate-200 flex justify-between items-center">
                        <h3 className="font-bold text-slate-700 flex items-center gap-2">
                            <Icons.Activity size={18} /> FX Sensitivity Simulation
                        </h3>
                        <span className="text-xs bg-slate-200 px-2 py-1 rounded text-slate-600">Impact on Total Equity</span>
                    </div>
                    <div className="p-6">
                        <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                            {/* Negative Shock */}
                            <div className="space-y-4">
                                <div className="flex justify-between items-center text-sm">
                                    <span className="text-slate-500">FX Strengthens 5%</span>
                                    <span className="font-mono font-bold text-emerald-600">
                                        {(dashboardData.sensitivity.plus5).toLocaleString(undefined, {maximumFractionDigits:0})}
                                    </span>
                                </div>
                                <div className="flex justify-between items-center text-sm">
                                    <span className="text-slate-500">FX Strengthens 1%</span>
                                    <span className="font-mono font-bold text-emerald-600">
                                        {(dashboardData.sensitivity.plus1).toLocaleString(undefined, {maximumFractionDigits:0})}
                                    </span>
                                </div>
                            </div>

                            {/* Base */}
                            <div className="flex flex-col items-center justify-center border-x border-slate-100 bg-slate-50/50 rounded-lg py-2">
                                <span className="text-xs font-bold text-slate-400 uppercase mb-1">Current Baseline</span>
                                <span className="text-xl font-bold text-slate-800">
                                    {dashboardData.totalValue.toLocaleString(undefined, {maximumFractionDigits:0})}
                                </span>
                            </div>

                            {/* Positive Shock */}
                            <div className="space-y-4">
                                <div className="flex justify-between items-center text-sm">
                                    <span className="text-slate-500">FX Weakens 1%</span>
                                    <span className="font-mono font-bold text-red-600">
                                        {(dashboardData.sensitivity.minus1).toLocaleString(undefined, {maximumFractionDigits:0})}
                                    </span>
                                </div>
                                <div className="flex justify-between items-center text-sm">
                                    <span className="text-slate-500">FX Weakens 5%</span>
                                    <span className="font-mono font-bold text-red-600">
                                        {(dashboardData.sensitivity.minus5).toLocaleString(undefined, {maximumFractionDigits:0})}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        );

        const Registry = ({ isLocked, form, handleFormChange, handleAddAsset, loading, assets, reportingCurrency, calculateValuation }) => {
            
            // Calculate totals for footer
            const totalReportedValue = useMemo(() => {
                return assets.reduce((sum, asset) => sum + calculateValuation(asset).value, 0);
            }, [assets, calculateValuation]);

            const exportToCSV = () => {
                if (assets.length === 0) return;
                
                const headers = [
                    "Ref ID", "Asset Name", "Entity", "Country", "Type", "Class", 
                    "Purchase Date", "Currency", "Carrying Value FC", 
                    "Rate Used", "Valuation Method", 
                    "Reported Value (" + reportingCurrency + ")", "Volatility Risk"
                ];

                const rows = assets.map(asset => {
                    const val = calculateValuation(asset);
                    return [
                        asset.id,
                        `"${asset.name}"`, 
                        `"${asset.entity}"`,
                        `"${asset.country}"`,
                        asset.assetType,
                        asset.monetary ? 'Monetary' : 'Non-Monetary',
                        asset.purchaseDate,
                        asset.currency,
                        asset.carryingValueFC,
                        val.rateUsed.toFixed(4),
                        val.method,
                        val.value.toFixed(2),
                        (asset.rates.volatility * 100).toFixed(2) + "%"
                    ];
                });

                const csvContent = "data:text/csv;charset=utf-8," 
                    + headers.join(",") + "\n" 
                    + rows.map(e => e.join(",")).join("\n");

                const encodedUri = encodeURI(csvContent);
                const link = document.createElement("a");
                link.setAttribute("href", encodedUri);
                link.setAttribute("download", `finverse_asset_registry_${new Date().toISOString().split('T')[0]}.csv`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            };

            return (
                <div className="space-y-6 animate-fadeIn">
                    {/* Input Form */}
                    {!isLocked && (
                        <div className="glass-card p-6 rounded-xl">
                            <h3 className="font-bold text-slate-800 mb-4 flex items-center gap-2">
                                <Icons.PlusCircle size={18} className="text-blue-600"/> Add Asset to Registry
                            </h3>
                            <form onSubmit={handleAddAsset} className="grid grid-cols-1 md:grid-cols-4 gap-4">
                                <input name="entity" value={form.entity} onChange={handleFormChange} placeholder="Entity / Subsidiary" className="p-2 border rounded text-sm" required />
                                <input name="country" value={form.country} onChange={handleFormChange} placeholder="Country" className="p-2 border rounded text-sm" required />
                                <input name="name" value={form.name} onChange={handleFormChange} placeholder="Asset Description" className="p-2 border rounded text-sm md:col-span-2" required />
                                
                                <select name="assetType" value={form.assetType} onChange={handleFormChange} className="p-2 border rounded text-sm">
                                    {ASSET_TYPES.map(t => <option key={t.id} value={t.id}>{t.label}</option>)}
                                </select>
                                
                                <div className="flex gap-2 md:col-span-2">
                                    <input type="number" name="carryingValueFC" value={form.carryingValueFC} onChange={handleFormChange} placeholder="Value" className="p-2 border rounded text-sm flex-1" required />
                                    <select name="currency" value={form.currency} onChange={handleFormChange} className="p-2 border rounded text-sm w-24">
                                        {CURRENCIES.map(c => <option key={c} value={c}>{c}</option>)}
                                    </select>
                                </div>
                                
                                <input type="date" name="purchaseDate" value={form.purchaseDate} onChange={handleFormChange} className="p-2 border rounded text-sm" required />
                                
                                {/* Rate Selection */}
                                <div className="flex gap-2 md:col-span-2">
                                    <select name="valuationBasis" value={form.valuationBasis} onChange={handleFormChange} className="p-2 border rounded text-sm flex-1">
                                        {VALUATION_BASIS_OPTIONS.map(o => <option key={o.id} value={o.id}>{o.label}</option>)}
                                    </select>
                                    {form.valuationBasis === 'MANUAL' && (
                                        <input 
                                            type="number" 
                                            name="manualRate" 
                                            value={form.manualRate} 
                                            onChange={handleFormChange} 
                                            placeholder="Rate" 
                                            step="0.0001"
                                            className="p-2 border rounded text-sm w-24" 
                                            required 
                                        />
                                    )}
                                </div>

                                <button disabled={loading} className="bg-slate-900 text-white rounded px-4 py-2 text-sm font-medium hover:bg-slate-800 disabled:opacity-50 md:col-span-2 flex justify-center items-center">
                                    {loading ? <Icons.Loader2 className="animate-spin mr-2" size={16}/> : 'Register Asset'}
                                </button>
                            </form>
                        </div>
                    )}

                    {/* Table Utility Bar */}
                    <div className="flex justify-between items-center px-2">
                        <h3 className="font-bold text-slate-700">Registered Assets</h3>
                        <button 
                            onClick={exportToCSV}
                            disabled={assets.length === 0}
                            className="text-sm flex items-center gap-2 px-3 py-1.5 bg-white border border-slate-200 rounded text-slate-600 hover:text-blue-600 hover:border-blue-200 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
                        >
                            <Icons.Download size={16}/> Export Registry
                        </button>
                    </div>

                    {/* Table */}
                    <div className="glass-card rounded-xl overflow-hidden">
                        <div className="overflow-x-auto custom-scroll">
                            <table className="w-full text-left border-collapse">
                                <thead className="bg-slate-50 border-b border-slate-200">
                                    <tr>
                                        <th className="p-4 text-xs font-bold text-slate-500 uppercase">Ref ID</th>
                                        <th className="p-4 text-xs font-bold text-slate-500 uppercase">Details</th>
                                        <th className="p-4 text-xs font-bold text-slate-500 uppercase">Class</th>
                                        <th className="p-4 text-xs font-bold text-slate-500 uppercase text-right">Carrying (FC)</th>
                                        <th className="p-4 text-xs font-bold text-slate-500 uppercase text-right">Exch. Rate</th>
                                        <th className="p-4 text-xs font-bold text-slate-500 uppercase text-right">Reported ({reportingCurrency})</th>
                                        <th className="p-4 text-xs font-bold text-slate-500 uppercase text-center">Risk</th>
                                    </tr>
                                </thead>
                                <tbody className="divide-y divide-slate-100 text-sm">
                                    {assets.length === 0 ? (
                                        <tr><td colSpan="7" className="p-8 text-center text-slate-400">Registry is empty.</td></tr>
                                    ) : (
                                        assets.map(asset => {
                                            const val = calculateValuation(asset);
                                            const risk = getRiskScore(asset.rates.volatility);
                                            return (
                                                <tr key={asset.id} className="hover:bg-slate-50">
                                                    <td className="p-4 font-mono text-xs text-slate-400">{asset.id.slice(0,6)}</td>
                                                    <td className="p-4">
                                                        <div className="font-medium text-slate-800">{asset.name}</div>
                                                        <div className="text-xs text-slate-500">{asset.entity}, {asset.country}</div>
                                                    </td>
                                                    <td className="p-4">
                                                        <span className={`px-2 py-0.5 rounded text-[10px] font-bold ${asset.monetary ? 'bg-blue-100 text-blue-700' : 'bg-purple-100 text-purple-700'}`}>
                                                            {asset.monetary ? 'MONETARY' : 'NON-MONETARY'}
                                                        </span>
                                                        <div className="text-[10px] text-slate-400 mt-1">{asset.assetType}</div>
                                                    </td>
                                                    <td className="p-4 text-right font-mono">
                                                        {asset.carryingValueFC.toLocaleString()} {asset.currency}
                                                    </td>
                                                    <td className="p-4 text-right">
                                                        <div className="font-mono font-bold text-blue-600">{val.rateUsed.toFixed(4)}</div>
                                                        <div className="text-[10px] text-slate-400">{val.method}</div>
                                                    </td>
                                                    <td className="p-4 text-right font-bold text-slate-900">
                                                        {val.value.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                                    </td>
                                                    <td className="p-4 text-center">
                                                        <span className={`px-2 py-1 rounded text-[10px] font-bold ${risk.color}`}>
                                                            {risk.label}
                                                        </span>
                                                        <div className="text-[10px] text-slate-400 mt-0.5">Vol: {(asset.rates.volatility * 100).toFixed(1)}%</div>
                                                    </td>
                                                </tr>
                                            );
                                        })
                                    )}
                                </tbody>
                                {/* Totals Footer */}
                                {assets.length > 0 && (
                                    <tfoot className="bg-slate-100 border-t border-slate-300">
                                        <tr>
                                            <td colSpan="5" className="p-4 text-right text-xs font-bold text-slate-600 uppercase tracking-wider">
                                                Total Reported Value ({reportingCurrency})
                                            </td>
                                            <td className="p-4 text-right font-black text-slate-900 text-base">
                                                {totalReportedValue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}
                                            </td>
                                            <td></td>
                                        </tr>
                                    </tfoot>
                                )}
                            </table>
                        </div>
                    </div>
                </div>
            );
        };

        // --- Main Application ---
        const App = () => {
            // --- State ---
            const [activeTab, setActiveTab] = useState('dashboard');
            const [reportingCurrency, setReportingCurrency] = useState('INR');
            const [reportingDate, setReportingDate] = useState(new Date().toISOString().split('T')[0]);
            
            // Core Data - Initialize with Mock Data
            const [assets, setAssets] = useState(MOCK_ASSETS);
            const [isLocked, setIsLocked] = useState(false); // Reporting lock
            const [loading, setLoading] = useState(false);

            // Form State
            const [form, setForm] = useState({
                entity: "",
                country: "",
                assetType: "PPE",
                name: "",
                purchaseDate: new Date().toISOString().split('T')[0],
                carryingValueFC: "", // Foreign Currency Value
                currency: "USD",
                valuationBasis: "IAS21",
                manualRate: ""
            });

            // --- Handlers ---
            const handleFormChange = (e) => setForm({ ...form, [e.target.name]: e.target.value });

            const handleAddAsset = async (e) => {
                e.preventDefault();
                if (!form.carryingValueFC || !form.name) return;
                
                setLoading(true);
                const fxData = await fetchFXData(form.currency, reportingCurrency, form.purchaseDate);
                setLoading(false);

                if (fxData) {
                    const typeDef = ASSET_TYPES.find(t => t.id === form.assetType);
                    const newAsset = {
                        id: crypto.randomUUID(),
                        ...form,
                        carryingValueFC: parseFloat(form.carryingValueFC),
                        monetary: typeDef.monetary,
                        rates: fxData,
                        valuationBasis: form.valuationBasis,
                        manualOverrideRate: form.valuationBasis === 'MANUAL' ? parseFloat(form.manualRate) : null,
                        treatment: typeDef.monetary ? "Closing Rate (IAS 21)" : "Historical Rate (IAS 21)"
                    };
                    setAssets(prev => [...prev, newAsset]);
                    setForm({ ...form, name: "", carryingValueFC: "" }); // Clear inputs
                } else {
                    alert("FX Data Fetch Failed. Check connectivity.");
                }
            };

            const toggleLock = () => setIsLocked(!isLocked);

            // --- Logic Engine (IAS 21 + Overrides) ---
            const calculateValuation = useCallback((asset) => {
                // 1. Explicit Rate Selection
                if (asset.valuationBasis === 'MANUAL' && asset.manualOverrideRate) {
                    return { rateUsed: asset.manualOverrideRate, value: asset.carryingValueFC * asset.manualOverrideRate, method: "Manual Override" };
                }
                if (asset.valuationBasis === 'HISTORICAL') {
                    return { rateUsed: asset.rates.purchaseSpot, value: asset.carryingValueFC * asset.rates.purchaseSpot, method: "Historical Spot" };
                }
                if (asset.valuationBasis === 'CLOSING') {
                    return { rateUsed: asset.rates.closingRate, value: asset.carryingValueFC * asset.rates.closingRate, method: "Closing Spot" };
                }
                if (asset.valuationBasis === 'AVG_30') {
                    return { rateUsed: asset.rates.avg30, value: asset.carryingValueFC * asset.rates.avg30, method: "30-Day Avg" };
                }

                // 2. Default IAS 21 Logic
                if (asset.monetary) {
                    return {
                        rateUsed: asset.rates.closingRate,
                        value: asset.carryingValueFC * asset.rates.closingRate,
                        method: "Closing Rate (IAS 21)"
                    };
                }

                return {
                    rateUsed: asset.rates.purchaseSpot,
                    value: asset.carryingValueFC * asset.rates.purchaseSpot,
                    method: "Historical Rate (IAS 21)"
                };
            }, []);

            // --- Aggregates for Dashboard ---
            const dashboardData = useMemo(() => {
                let totalValue = 0;
                let totalOriginalCost = 0; 
                let sensitivity = { plus1: 0, minus1: 0, plus5: 0, minus5: 0 };
                let highRiskCount = 0;

                assets.forEach(asset => {
                    const valuation = calculateValuation(asset);
                    totalValue += valuation.value;

                    const historicalVal = asset.carryingValueFC * asset.rates.purchaseSpot;
                    totalOriginalCost += historicalVal;

                    if (asset.monetary) {
                        const baseVal = asset.carryingValueFC * asset.rates.closingRate;
                        sensitivity.plus1 += baseVal * 1.01;
                        sensitivity.minus1 += baseVal * 0.99;
                        sensitivity.plus5 += baseVal * 1.05;
                        sensitivity.minus5 += baseVal * 0.95;
                    } else {
                        const staticVal = asset.carryingValueFC * asset.rates.purchaseSpot;
                        sensitivity.plus1 += staticVal;
                        sensitivity.minus1 += staticVal;
                        sensitivity.plus5 += staticVal;
                        sensitivity.minus5 += staticVal;
                    }

                    const risk = getRiskScore(asset.rates.volatility);
                    if (risk.label === 'High') highRiskCount++;
                });

                return {
                    totalValue,
                    translationImpact: totalValue - totalOriginalCost,
                    sensitivity,
                    highRiskCount,
                    assetCount: assets.length
                };
            }, [assets, calculateValuation]);

            return (
                <div className="min-h-screen bg-slate-50 p-4 md:p-8 max-w-7xl mx-auto">
                    {/* App Header */}
                    <div className="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
                        <div>
                            <h1 className="text-2xl font-bold text-slate-900 tracking-tight flex items-center gap-2">
                                <Icons.Globe size={28} className="text-blue-600" />
                                Finverse <span className="text-slate-400 font-light">Asset Valuator</span>
                            </h1>
                            <p className="text-xs text-slate-500 font-medium tracking-wide mt-1 uppercase">IAS 21 compliant translation engine</p>
                        </div>
                        <div className="flex gap-4">
                            <div className="text-right">
                                <div className="text-[10px] font-bold text-slate-400 uppercase">Reporting Currency</div>
                                <select 
                                    value={reportingCurrency} 
                                    onChange={(e) => setReportingCurrency(e.target.value)} 
                                    className="bg-transparent font-bold text-slate-800 text-right outline-none cursor-pointer"
                                    disabled={isLocked}
                                >
                                    {CURRENCIES.map(c => <option key={c} value={c}>{c}</option>)}
                                </select>
                            </div>
                            <div className="text-right border-l border-slate-200 pl-4">
                                <div className="text-[10px] font-bold text-slate-400 uppercase">Controls</div>
                                <button 
                                    onClick={toggleLock} 
                                    className={`text-xs font-bold flex items-center gap-1 mt-0.5 ${isLocked ? 'text-red-600' : 'text-slate-600 hover:text-blue-600'}`}
                                >
                                    {isLocked ? <><Icons.Lock size={12}/> Locked</> : <><Icons.Unlock size={12}/> Open</>}
                                </button>
                            </div>
                        </div>
                    </div>

                    {/* Navigation */}
                    <div className="flex border-b border-slate-200 mb-6">
                        <button 
                            onClick={() => setActiveTab('dashboard')}
                            className={`px-4 py-2 text-sm font-medium flex items-center gap-2 transition-colors ${activeTab === 'dashboard' ? 'tab-active' : 'tab-inactive'}`}
                        >
                            <Icons.LayoutDashboard size={16}/> Pre-Close Dashboard
                        </button>
                        <button 
                            onClick={() => setActiveTab('registry')}
                            className={`px-4 py-2 text-sm font-medium flex items-center gap-2 transition-colors ${activeTab === 'registry' ? 'tab-active' : 'tab-inactive'}`}
                        >
                            <Icons.Table2 size={16}/> Asset Registry
                        </button>
                    </div>

                    {/* Content Area */}
                    {activeTab === 'dashboard' ? (
                        <Dashboard 
                            reportingCurrency={reportingCurrency}
                            dashboardData={dashboardData}
                            reportingDate={reportingDate}
                            isLocked={isLocked}
                        />
                    ) : (
                        <Registry 
                            isLocked={isLocked}
                            form={form}
                            handleFormChange={handleFormChange}
                            handleAddAsset={handleAddAsset}
                            loading={loading}
                            assets={assets}
                            reportingCurrency={reportingCurrency}
                            calculateValuation={calculateValuation}
                        />
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
