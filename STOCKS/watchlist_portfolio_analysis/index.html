<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>StockSight Cloud</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .text-maroon { color: #800000; }
        .bg-maroon { background-color: #800000; }
        .border-maroon { border-color: #800000; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #800000;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .signal-buy { color: #10B981; background: #ECFDF5; border: 1px solid #10B981; }
        .signal-sell { color: #EF4444; background: #FEF2F2; border: 1px solid #EF4444; }
        .signal-hold { color: #F59E0B; background: #FFFBEB; border: 1px solid #F59E0B; }
        .signal-sip { color: #3B82F6; background: #EFF6FF; border: 1px solid #3B82F6; }
        .signal-gray { color: #6B7280; background: #F3F4F6; border: 1px solid #E5E7EB; }
        .watchlist-item:hover .delete-btn { opacity: 1; }
        .portfolio-input {
            width: 100%;
            padding: 4px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            font-size: 12px;
            text-align: right;
            background: #f9fafb;
        }
        .portfolio-input:focus { outline: 1px solid #800000; background: white; }
        .tab-active { border-bottom: 2px solid #800000; color: #800000; font-weight: 600; }
        .tab-inactive { color: #6b7280; border-bottom: 2px solid transparent; }
        .tab-inactive:hover { color: #374151; border-bottom: 2px solid #e5e7eb; }
        .badge-stock { background: #e0e7ff; color: #3730a3; }
        .badge-fund { background: #fef3c7; color: #92400e; }
        .badge-etf { background: #dcfce7; color: #166534; }
        .badge-gfin { background: #fee2e2; color: #991b1b; } 
        .updating { opacity: 0.6; pointer-events: none; filter: grayscale(0.5); }
        .score-bar-bg { background-color: #e5e7eb; height: 6px; border-radius: 3px; overflow: hidden; }
        .score-bar-fill { height: 100%; border-radius: 3px; }
        
        /* New Toggle Styles */
        .analysis-tab { font-size: 10px; padding: 2px 8px; border-radius: 12px; cursor: pointer; transition: all 0.2s; border: 1px solid transparent; }
        .analysis-tab.active-fund { background: #fee2e2; color: #800000; border-color: #fecaca; font-weight: 600; }
        .analysis-tab.active-port { background: #dbeafe; color: #1e40af; border-color: #bfdbfe; font-weight: 600; }
        .analysis-tab.inactive { background: white; color: #9ca3af; border-color: #e5e7eb; }
        .analysis-tab.inactive:hover { background: #f9fafb; color: #4b5563; }
    </style>
</head>
<body class="h-screen flex flex-col md:flex-row overflow-hidden text-gray-800" onload="initApp()">

    <!-- SIDEBAR -->
    <aside class="w-full md:w-80 bg-white border-r border-gray-200 flex flex-col z-20 shadow-lg shrink-0 h-1/3 md:h-full">
        <div class="p-4 border-b border-gray-200 bg-white">
            <div class="flex justify-between items-center mb-3">
                <h1 class="font-bold text-gray-800 tracking-tight flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-maroon"></span>
                    Terminal
                </h1>
                <div class="flex items-center gap-2">
                    <button onclick="forceSync()" class="text-gray-400 hover:text-maroon transition" title="Force Cloud Sync">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    </button>
                    <span id="watchlist-count" class="text-xs text-gray-400 font-mono">0 / 50</span>
                </div>
            </div>
            <div class="relative space-y-2">
                <div class="relative">
                    <input type="text" id="stockInput" 
                        class="w-full pl-8 pr-16 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:border-maroon focus:ring-1 focus:ring-maroon uppercase"
                        placeholder="Symbol (INFY) or MF Code"
                        onkeypress="handleEnter(event)">
                    <svg class="w-4 h-4 text-gray-400 absolute left-2.5 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    <button onclick="processInput()" class="absolute right-1 top-1 bottom-1 px-3 bg-gray-100 hover:bg-gray-200 text-xs font-semibold rounded text-gray-600">Add</button>
                </div>
            </div>
        </div>

        <div id="watchlist-container" class="flex-1 overflow-y-auto custom-scroll">
            <div id="empty-watchlist" class="p-8 text-center text-gray-400 text-sm italic">
                <div class="loader mx-auto mb-2"></div>
                Connecting to Google Sheets...
            </div>
        </div>

        <div class="p-3 bg-gray-50 border-t border-gray-200 text-xs flex justify-between text-gray-500 items-center">
            <div id="cloud-status" class="flex items-center gap-2 cursor-pointer" onclick="forceSync()" title="Click to Retry Connection">
                <span class="w-2 h-2 rounded-full bg-gray-400"></span>
                <span>Connecting...</span>
            </div>
            <div id="requestCounter" class="hidden text-maroon font-semibold">Updating...</div>
        </div>
    </aside>

    <!-- MAIN DASHBOARD -->
    <main class="flex-1 overflow-y-auto custom-scroll bg-gray-100 flex flex-col h-2/3 md:h-full relative">
        
        <!-- Top Bar -->
        <div class="bg-white border-b border-gray-200 px-6 py-4 shadow-sm flex flex-wrap justify-between items-center gap-4 sticky top-0 z-10">
            <div class="flex items-center gap-6">
                <!-- TABS -->
                <div class="flex space-x-6 text-sm font-medium">
                    <button id="tab-portfolio" onclick="switchTab('portfolio')" class="tab-active py-1 transition-colors flex items-center gap-2">
                        <span>My Portfolio</span>
                        <span id="badge-port-count" class="bg-red-100 text-maroon text-[10px] px-1.5 py-0.5 rounded-full">0</span>
                    </button>
                    <button id="tab-watchlist" onclick="switchTab('watchlist')" class="tab-inactive py-1 transition-colors flex items-center gap-2">
                        <span>Watchlist</span>
                        <span id="badge-watch-count" class="bg-gray-100 text-gray-500 text-[10px] px-1.5 py-0.5 rounded-full">0</span>
                    </button>
                    <button id="tab-summary" onclick="switchTab('summary')" class="tab-inactive py-1 transition-colors">Signals</button>
                </div>
            </div>

            <div class="flex gap-6 text-sm">
                <div class="text-right">
                    <p class="text-[10px] text-gray-500 uppercase font-semibold">Current Value</p>
                    <p id="total-value" class="font-bold text-gray-800 text-lg leading-tight">₹0</p>
                </div>
                <div class="text-right">
                    <p class="text-[10px] text-gray-500 uppercase font-semibold">Total P&L</p>
                    <p id="total-pnl" class="font-bold text-gray-400 text-lg leading-tight">₹0</p>
                </div>
            </div>
        </div>

        <!-- Global Error -->
        <div id="globalError" class="hidden m-4 bg-red-50 border-l-4 border-red-500 text-red-700 p-4 text-sm rounded shadow-sm">
            <p class="font-bold">Fetch Error</p>
            <p id="globalErrorMsg">Unable to fetch data.</p>
        </div>

        <!-- TAB 1: PORTFOLIO GRID -->
        <div id="view-portfolio" class="p-4 md:p-6 grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
            <div id="portfolio-empty" class="col-span-full hidden flex-col items-center justify-center text-gray-400 py-12">
                <p>No holdings yet.</p>
                <p class="text-xs">Add Qty to a watchlist item to move it here.</p>
            </div>
        </div>

        <!-- TAB 2: WATCHLIST GRID -->
        <div id="view-watchlist" class="hidden p-4 md:p-6 grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
            <div id="watchlist-empty" class="col-span-full hidden flex-col items-center justify-center text-gray-400 py-12">
                <p>Watchlist empty.</p>
                <p class="text-xs">Use the sidebar to search and add stocks.</p>
            </div>
        </div>

        <!-- TAB 3: SIGNAL SUMMARY -->
        <div id="view-summary" class="hidden p-4 md:p-6 grid grid-cols-1 md:grid-cols-3 gap-6 h-full items-start">
            <!-- BUY -->
            <div class="bg-white rounded-lg border border-green-100 shadow-sm overflow-hidden h-full">
                <div class="bg-green-50 px-4 py-3 border-b border-green-100 flex justify-between items-center">
                    <h3 class="text-green-800 font-bold text-sm uppercase">Stock Buys</h3>
                    <span id="count-buy" class="text-xs bg-white text-green-700 px-2 py-0.5 rounded font-bold">0</span>
                </div>
                <div id="list-buy" class="p-2 space-y-1 overflow-y-auto max-h-[500px] custom-scroll"></div>
            </div>
            <!-- FUNDS -->
            <div class="bg-white rounded-lg border border-blue-100 shadow-sm overflow-hidden h-full">
                <div class="bg-blue-50 px-4 py-3 border-b border-blue-100 flex justify-between items-center">
                    <h3 class="text-blue-800 font-bold text-sm uppercase">Funds / ETFs</h3>
                    <span id="count-sip" class="text-xs bg-white text-blue-700 px-2 py-0.5 rounded font-bold">0</span>
                </div>
                <div id="list-sip" class="p-2 space-y-1 overflow-y-auto max-h-[500px] custom-scroll"></div>
            </div>
            <!-- HOLD -->
            <div class="bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden h-full">
                <div class="bg-gray-100 px-4 py-3 border-b border-gray-200 flex justify-between items-center">
                    <h3 class="text-gray-800 font-bold text-sm uppercase">Wait / Avoid / Hold</h3>
                    <span id="count-hold" class="text-xs bg-white text-gray-700 px-2 py-0.5 rounded font-bold">0</span>
                </div>
                <div id="list-hold" class="p-2 space-y-1 overflow-y-auto max-h-[500px] custom-scroll"></div>
            </div>
        </div>

        <div id="main-empty-state" class="flex-1 flex flex-col items-center justify-center text-gray-300 p-10 hidden">
            <p class="text-lg font-medium text-gray-400">Loading Portfolio...</p>
        </div>

    </main>

    <script>
        // --- GOOGLE SHEET CONFIG ---
        const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbyScFGyxqSwudrvbCngaPtlKxtHlS4O8Q7bj4FcQEESir3LFSlnHquPxskKsBKC9kS1VQ/exec";

        // --- STATE ---
        let portfolio = {}; 
        let livePrices = {}; 
        let stockAnalysis = {}; 
        let cardViews = {}; // Stores toggle state per symbol 'fundamental' | 'porter'
        let activeTab = 'portfolio';
        let saveTimeout = null;
        let isOfflineMode = false;
        let activeRequests = 0;

        // --- HELPER FUNCTIONS ---
        function cleanTicker(sym) {
            return sym.replace(/\.NS$/, '').replace(/\.BO$/, '').replace(/:NSE$/, '').replace(/:BSE$/, '');
        }

        function updateCloudStatus(status, text) {
            const el = document.getElementById('cloud-status');
            if(!el) return;
            let color = 'bg-gray-400';
            if (status === 'loading') color = 'bg-yellow-400 animate-pulse';
            if (status === 'success') color = 'bg-green-500';
            if (status === 'error') color = 'bg-red-500';
            el.innerHTML = `<span class="w-2 h-2 rounded-full ${color}"></span><span>${text}</span>`;
        }

        function updateReqCount() {
            const el = document.getElementById('requestCounter');
            if(el) el.style.display = activeRequests > 0 ? 'block' : 'none';
        }

        function calculateMFReturns(history) {
            if(!history || !Array.isArray(history) || history.length < 10) return { r1y:0, r3y:0, r5y:0 };
            const now = parseFloat(history[0].nav);
            
            const parseDate = (dStr) => { 
                const [d, m, y] = dStr.split('-'); 
                return new Date(`${y}-${m}-${d}`); 
            };

            const findNavAgo = (years) => {
                const targetDate = new Date();
                targetDate.setFullYear(targetDate.getFullYear() - years);
                const entry = history.find(h => parseDate(h.date) <= targetDate);
                return entry ? parseFloat(entry.nav) : null;
            };

            const r1yNav = findNavAgo(1); 
            const r3yNav = findNavAgo(3); 
            const r5yNav = findNavAgo(5);

            const cagr = (end, start, years) => ((Math.pow(end/start, 1/years) - 1) * 100);

            return { 
                r1y: r1yNav ? cagr(now, r1yNav, 1) : 0, 
                r3y: r3yNav ? cagr(now, r3yNav, 3) : 0, 
                r5y: r5yNav ? cagr(now, r5yNav, 5) : 0 
            };
        }

        // --- SCORING ENGINE 1: FUNDAMENTAL (Stocks & Funds) ---
        function calculateFundamentalScore(data) {
            let scores = { business: 0, moat: 0, management: 0, risk: 0, total: 0, explanation: "" };
            let reasons = [];
            
            // --- ETF / FUND SCORING ---
            if (data.type === 'FUND' || data.type === 'ETF') {
                const ret1y = data.returns?.r1y || 0;
                const ret3y = data.returns?.r3y || 0;
                const ret5y = data.returns?.r5y || 0;
                const price = data.price || 0;
                const high52 = data.technicals?.high52 || price;
                
                // 1. MF (History Available)
                if (data.type === 'FUND' || (data.source !== 'Google' && ret1y !== 0)) {
                     let totalScore = 0;
                     if (ret1y > 15) totalScore += 40; else if (ret1y > 10) totalScore += 30; else if (ret1y > 0) totalScore += 15;
                     if (ret3y > 12) totalScore += 30; else if (ret3y > 8) totalScore += 20; else if (ret3y > 0) totalScore += 10;
                     if (ret5y > 10) totalScore += 30; else if (ret5y > 8) totalScore += 20; else if (ret5y > 0) totalScore += 10;
                     
                     scores.total = Math.min(99, totalScore); // Cap at 99
                     scores.business = Math.min(40, Math.round(totalScore * 0.4));
                     scores.moat = Math.min(20, Math.round(totalScore * 0.3));
                     scores.management = Math.min(20, Math.round(totalScore * 0.2));
                     scores.risk = ret1y > ret3y ? 20 : 10;
                     scores.explanation = "Based on Returns";
                } 
                // 2. ETF (Trend Only)
                else if (high52 > 0) {
                    const low52 = data.technicals?.low52 || (high52 * 0.7); 
                    const range = high52 - low52;
                    const position = ((price - low52) / range) * 100;
                    scores.total = Math.min(99, Math.round(20 + (position * 0.7))); // Cap at 99
                    scores.business = Math.round(scores.total * 0.4);
                    scores.moat = Math.round(scores.total * 0.2);
                    scores.management = Math.round(scores.total * 0.2);
                    scores.risk = Math.round(scores.total * 0.2);
                    scores.explanation = "Trend Strength";
                } else {
                     return null;
                }
            } 
            // --- STOCK SCORING ---
            else {
                const roe = data.roe || 0;
                const roce = data.roce || 0; 
                const salesGrowth = data.growth || 0; 
                const profitGrowth = data.profitGrowth || 0;
                const opm = data.opm || 0; 
                const pe = data.pe || 0;
                const mcap = data.mcap || 0; 
                const beta = data.beta || 1.0;
                const ret1y = data.returns?.r1y || 0;

                const isFinancial = (roce < 12 && roe > 15) || (data.name && (data.name.toUpperCase().includes("FINANCE") || data.name.toUpperCase().includes("BANK") || data.name.toUpperCase().includes("CAPITAL")));
                
                // 1. Business Strength
                if (salesGrowth > 15) scores.business += 15; else if (salesGrowth > 8) scores.business += 10; else if (salesGrowth > 0) scores.business += 5;
                if (profitGrowth > 15) scores.business += 15; else if (profitGrowth > 8) scores.business += 10; else if (profitGrowth > 0) scores.business += 5;
                if (isFinancial) { if (roe > 15) scores.business += 10; else if (roe > 10) scores.business += 5; }
                else { if (opm > 20) scores.business += 10; else if (opm > 12) scores.business += 5; }
                scores.business = Math.min(40, scores.business);

                // 2. Moat
                if (isFinancial) { if (roe > 18) scores.moat += 8; else if (roe > 12) scores.moat += 5; }
                else { if (opm > 18) scores.moat += 5; if (roce > 20) scores.moat += 5; }
                if (mcap > 20000) scores.moat += 5; else if (mcap > 5000) scores.moat += 3;
                if (profitGrowth > salesGrowth) scores.moat += 5; 
                if (ret1y > 40) scores.moat = Math.max(scores.moat + 5, 18);
                scores.moat = Math.min(20, scores.moat);

                // 3. Management
                if (pe > 0) {
                    if (pe < 15 && (profitGrowth > 10 || roe > 15)) scores.management += 20; 
                    else if (pe < 25) scores.management += 10;
                    else if (pe < 60) scores.management += 5;
                }
                scores.management = Math.min(20, scores.management);

                // 4. Risk
                if (mcap > 5000) scores.risk += 10; else if (mcap > 2000) scores.risk += 5;
                if (ret1y > 40) scores.risk += 10; else { if (beta < 1.1) scores.risk += 10; else if (beta < 1.3) scores.risk += 5; }
                scores.risk = Math.min(20, scores.risk);

                scores.total = scores.business + scores.moat + scores.management + scores.risk;

                // MAGIC BOOST
                if (pe < 15 && roe > 15 && profitGrowth > 0) { scores.total += 15; reasons.push("High Quality Value"); }
                else if (pe < 12 && profitGrowth > 10) { scores.total += 10; reasons.push("Deep Value"); }

                scores.total = Math.min(99, scores.total); // Cap at 99
                if (reasons.length > 0) scores.explanation = reasons.slice(0, 2).join(" & ");
                else scores.explanation = scores.total > 50 ? "Stable" : "Weak";
            }
            return scores;
        }

        // --- SCORING ENGINE 2: PORTER'S 5 FORCES (Stocks Only) ---
        function calculatePortersScore(data) {
            if (data.type !== 'STOCK') return null;

            const roe = data.roe || 0;
            const roce = data.roce || 0;
            const salesGrowth = data.growth || 0;
            const profitGrowth = data.profitGrowth || 0;
            const opm = data.opm || 0;
            const mcap = data.mcap || 0;

            let pScore = { 
                entrants: 0, 
                suppliers: 0, 
                buyers: 0, 
                substitutes: 0, 
                rivalry: 0, 
                total: 0 
            };

            // 1. Threat of New Entrants (Barriers to Entry) - Max 20
            // High Capital (Mcap) & High Efficiency (ROCE) creates barriers
            if (mcap > 10000 && roce > 20) pScore.entrants = 20;
            else if (mcap > 5000 && roce > 15) pScore.entrants = 15;
            else if (mcap > 2000) pScore.entrants = 10;
            else pScore.entrants = 5;

            // 2. Bargaining Power of Suppliers - Max 20
            // High Margins imply suppliers don't control the business
            if (opm > 25) pScore.suppliers = 20;
            else if (opm > 18) pScore.suppliers = 15;
            else if (opm > 10) pScore.suppliers = 10;
            else pScore.suppliers = 5;

            // 3. Bargaining Power of Buyers - Max 20
            // High ROE implies pricing power (Brand)
            if (roe > 22) pScore.buyers = 20;
            else if (roe > 16) pScore.buyers = 15;
            else if (roe > 12) pScore.buyers = 10;
            else pScore.buyers = 5;

            // 4. Threat of Substitutes - Max 20
            // High Sales Growth implies the product is in demand/irreplaceable
            if (salesGrowth > 15) pScore.substitutes = 20;
            else if (salesGrowth > 10) pScore.substitutes = 15;
            else if (salesGrowth > 5) pScore.substitutes = 10;
            else pScore.substitutes = 5;

            // 5. Competitive Rivalry - Max 20
            // Consistent Profit Growth implies manageable competition
            if (profitGrowth > 15) pScore.rivalry = 20;
            else if (profitGrowth > 10) pScore.rivalry = 15;
            else if (profitGrowth > 0) pScore.rivalry = 10;
            else pScore.rivalry = 5;

            pScore.total = Math.min(99, pScore.entrants + pScore.suppliers + pScore.buyers + pScore.substitutes + pScore.rivalry); // Cap at 99
            return pScore;
        }

        // --- AUTO SAVE LOGIC ---
        function saveState(pushToCloud = true) {
            const state = { portfolio: portfolio, analysis: stockAnalysis, activeTab: activeTab, cardViews: cardViews };
            localStorage.setItem('stockSightData', JSON.stringify(state));
            
            // Update UI components
            calculateTotals();
            updateViewCounts();
            // Only update summary if active tab is summary to save resources
            if (activeTab === 'summary') renderSignalSummary();

            if (!pushToCloud) return;

            updateCloudStatus('loading', 'Saving...');
            
            if (saveTimeout) clearTimeout(saveTimeout);
            
            saveTimeout = setTimeout(async () => {
                if (isOfflineMode) { updateCloudStatus('error', 'Offline'); return; }
                try {
                    const res = await fetch(SHEET_API_URL, {
                        method: 'POST',
                        body: JSON.stringify(portfolio),
                        credentials: 'omit',
                        headers: { "Content-Type": "text/plain" } 
                    });
                    
                    const json = await res.json();
                    
                    if (json.status === 'success') {
                        updateCloudStatus('success', 'Saved');
                    } else {
                        throw new Error(json.message || "Script returned error");
                    }

                } catch (e) {
                    // Fallback to Blind POST
                    try {
                        await fetch(SHEET_API_URL, {
                            method: 'POST',
                            body: JSON.stringify(portfolio),
                            mode: 'no-cors',
                            credentials: 'omit',
                            headers: { "Content-Type": "text/plain" }
                        });
                        updateCloudStatus('success', 'Saved (Blind)');
                    } catch (err2) {
                        updateCloudStatus('error', 'Save Failed');
                    }
                }
            }, 2000); 
        }

        // --- INIT & PERSISTENCE ---
        async function initApp() {
            // 1. Load from Local Storage IMMEDIATELY
            const robustData = localStorage.getItem('stockSightData');
            if (robustData) {
                const state = JSON.parse(robustData);
                portfolio = state.portfolio || {};
                stockAnalysis = state.analysis || {};
                activeTab = state.activeTab || 'portfolio';
                cardViews = state.cardViews || {};
                
                // --- MIGRATION: CLEAN OLD .NS / .BO KEYS ---
                let migrationNeeded = false;
                Object.keys(portfolio).forEach(key => {
                    const clean = cleanTicker(key);
                    if (clean !== key) {
                        migrationNeeded = true;
                        // Move Portfolio Data
                        portfolio[clean] = portfolio[key];
                        delete portfolio[key];
                        
                        // Move Analysis Data
                        if (stockAnalysis[key]) {
                            stockAnalysis[clean] = stockAnalysis[key];
                            delete stockAnalysis[key];
                        }
                        
                        // Move View State
                        if (cardViews[key]) {
                            cardViews[clean] = cardViews[key];
                            delete cardViews[key];
                        }
                    }
                });
                
                if (migrationNeeded) {
                    console.log("Migrated legacy tickers");
                    saveState(false);
                }

                Object.keys(stockAnalysis).forEach(sym => {
                    if(stockAnalysis[sym].price) livePrices[sym] = stockAnalysis[sym].price;
                });
                renderUI();
            } else if (localStorage.getItem('stockPortfolio')) {
                portfolio = JSON.parse(localStorage.getItem('stockPortfolio'));
                renderUI();
            } else {
                document.getElementById('empty-watchlist').innerHTML = "Initializing...";
            }

            // 2. Cloud Sync Attempt
            await performCloudSync();

            // 3. Start Live Price Fetch
            const symbols = Object.keys(portfolio);
            if (symbols.length > 0) {
                setTimeout(() => {
                    symbols.forEach(sym => fetchAsset(sym));
                }, 100);
            }
        }

        async function performCloudSync() {
            updateCloudStatus('loading', 'Syncing...');
            isOfflineMode = false;

            try {
                const response = await fetch(SHEET_API_URL, { method: 'GET', credentials: 'omit' });
                if (!response.ok) throw new Error("HTTP " + response.status);
                const cloudData = await response.json();
                
                if (cloudData.status === 'error') throw new Error(cloudData.message);

                if (cloudData && Object.keys(cloudData).length > 0) {
                    portfolio = cloudData;
                    saveState(false); 
                    renderUI(); 
                } else if (Object.keys(portfolio).length > 0) {
                    saveState(true);
                }
                updateCloudStatus('success', 'Synced');
            } catch (e) {
                isOfflineMode = true;
                updateCloudStatus('error', 'Offline');
                document.getElementById('main-empty-state').classList.add('hidden');
                if (Object.keys(portfolio).length === 0) {
                     document.getElementById('empty-watchlist').innerHTML = "Offline Mode.<br>Add stocks locally.";
                }
            }
        }

        function forceSync() {
            sessionStorage.removeItem('syncErrorShown'); 
            performCloudSync();
        }

        function renderUI() {
            const symbols = Object.keys(portfolio);
            if (symbols.length > 0) {
                document.getElementById('empty-watchlist').classList.add('hidden');
                document.getElementById('main-empty-state').classList.add('hidden');
                
                symbols.forEach(sym => {
                    if (stockAnalysis[sym]) {
                        renderCard(sym, stockAnalysis[sym], true); 
                    } else {
                        createCardSkeleton(sym);
                    }
                    renderWatchlistItem(sym, !stockAnalysis[sym]);
                });
            }
            switchTab(activeTab);
            updateViewCounts();
            calculateTotals();
        }

        // --- FETCHING ---
        const PROXIES = [
            { url: (url) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`, type: 'text' },
            { url: (url) => `https://api.allorigins.win/get?url=${encodeURIComponent(url)}&t=${Date.now()}`, type: 'json' },
            { url: (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`, type: 'text' },
            { url: (url) => `https://thingproxy.freeboard.io/fetch/${encodeURIComponent(url)}`, type: 'text' }
        ];

        async function fetchWithFallback(targetUrl) {
            let lastError;
            for (const proxy of PROXIES) {
                try {
                    const controller = new AbortController();
                    const id = setTimeout(() => controller.abort(), 10000); 
                    const res = await fetch(proxy.url(targetUrl), { signal: controller.signal });
                    clearTimeout(id);
                    if(!res.ok) throw new Error(`HTTP ${res.status}`);
                    let content = proxy.type === 'json' ? (await res.json()).contents : await res.text();
                    if(!content || content.length < 50) throw new Error("Empty/Blocked");
                    if(targetUrl.includes('yahoo') && !content.trim().startsWith('{') && !content.includes('QuoteSummaryStore')) throw new Error("Invalid Yahoo");
                    return content;
                } catch(e) { lastError = e; }
            }
            throw lastError;
        }

        // --- ASSET ROUTER ---
        const ETF_KEYWORDS = ['BEES', 'ETF', 'GOLD', 'LIQUID', 'HANGSENG', 'NIFTY', 'SENSEX', 'MOVALUE', 'MOMENTUM', 'MIDCAP', 'SMALLCAP', 'JUNIOR'];

        async function fetchAsset(input) {
            activeRequests++;
            updateReqCount();
            const sym = input.toUpperCase();
            
            try {
                if (/^\d{5,6}$/.test(sym)) await fetchMutualFund(sym);
                else await fetchStockOrETF(sym);
                
                const card = document.getElementById(`card-${sym}`);
                if(card) card.classList.remove('updating');
            } catch(e) {
                renderErrorCard(sym, e.message);
            } finally {
                activeRequests--;
                updateReqCount();
            }
        }

        async function fetchMutualFund(code) {
            const url = `https://api.mfapi.in/mf/${code}`;
            const res = await fetch(url);
            if(!res.ok) throw new Error("MF Not Found");
            const json = await res.json();
            const data = { 
                name: json.meta.scheme_name, 
                price: parseFloat(json.data[0].nav), 
                type: 'FUND', 
                meta: json.meta.fund_house,
                returns: calculateMFReturns(json.data) 
            };
            livePrices[code] = data.price;
            renderCard(code, data);
        }

        async function fetchStockOrETF(sym, betaPromise) {
            const isLikelyETF = ETF_KEYWORDS.some(k => sym.includes(k));
            
            // 1. Screener (STOCKS ONLY)
            if (!isLikelyETF) {
                try {
                    const html = await fetchWithFallback(`https://www.screener.in/company/${sym}/consolidated/`);
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const ratios = doc.getElementById('top-ratios');
                    if (ratios) {
                        const getVal = (txt) => {
                            for(let li of ratios.querySelectorAll('li')) {
                                if(li.innerText.toLowerCase().includes(txt.toLowerCase())) return parseFloat(li.querySelector('.number')?.innerText.replace(/,/g,'') || 0);
                            }
                            return null;
                        };
                        const price = getVal('Current Price');
                        if(price) {
                            let growth = 0;
                            let opm = getVal('OPM %') || 0; 
                            let profitGrowth = 0;

                            const idxSales = html.indexOf("Compounded Sales Growth");
                            if(idxSales > -1) {
                                const sub = html.substring(idxSales, idxSales+1500);
                                let m = sub.match(/3 Years:[\s\S]*?([0-9\.-]+)\s?%/i);
                                growth = m ? parseFloat(m[1]) : 0;
                            }

                            const idxProfit = html.indexOf("Compounded Profit Growth");
                            if(idxProfit > -1) {
                                const sub = html.substring(idxProfit, idxProfit+1500);
                                let m = sub.match(/3 Years:[\s\S]*?([0-9\.-]+)\s?%/i);
                                profitGrowth = m ? parseFloat(m[1]) : 0;
                            }

                            let extraData = {};
                            try {
                                const yData = await fetchYahooQuote(`${sym}.NS`);
                                if(yData) extraData = { beta: yData.beta, returns: yData.returns };
                            } catch(e) {}

                            const data = { 
                                name: doc.querySelector('h1')?.innerText || sym, 
                                price: price, 
                                pe: getVal('Stock P/E'), 
                                roe: getVal('ROE'),
                                roce: getVal('ROCE'), 
                                mcap: getVal('Market Cap'),
                                opm: opm,
                                growth: growth,
                                profitGrowth: profitGrowth,
                                beta: extraData.beta || 1.0,
                                returns: extraData.returns, 
                                type: 'STOCK' 
                            };
                            livePrices[sym] = data.price;
                            renderCard(sym, data);
                            return; 
                        }
                    }
                } catch (e) {}
            }

            // 2. Yahoo (Last Resort)
            try {
                let targetSym = sym.endsWith('.NS') || sym.endsWith('.BO') ? sym : `${sym}.NS`;
                let data = await fetchYahooQuote(targetSym);
                if (!data && !sym.includes('.')) data = await fetchYahooQuote(`${sym}.BO`);
                if (data) {
                    livePrices[sym] = data.price;
                    renderCard(sym, data);
                    return;
                }
            } catch (yErr) {}

            try {
                const gData = await fetchGoogleFinance(sym);
                if (gData) {
                    livePrices[sym] = gData.price;
                    renderCard(sym, gData);
                    return;
                }
            } catch (gErr) {}

            throw new Error("Asset not found");
        }

        async function fetchYahooQuote(yahooSym) {
            try {
                const chartUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${yahooSym}?interval=1mo&range=5y`;
                const chartJsonStr = await fetchWithFallback(chartUrl);
                const chartJson = JSON.parse(chartJsonStr);
                const result = chartJson?.chart?.result?.[0];
                const meta = result?.meta;
                
                if (meta && meta.regularMarketPrice) {
                    const quotes = result.indicators.quote[0].close;
                    const calcRet = (months) => {
                        if(!quotes || quotes.length < months) return 0;
                        const curr = quotes[quotes.length-1];
                        const old = quotes[quotes.length - 1 - months];
                        if(!old) return 0;
                        const years = months/12;
                        return ((Math.pow(curr/old, 1/years) - 1) * 100);
                    };

                    const rawName = meta.symbol || yahooSym;
                    const cleanName = rawName.replace('.NS', '').replace('.BO', '');

                    return { 
                        name: cleanName, 
                        price: meta.regularMarketPrice, 
                        type: 'ETF', 
                        pe: null, 
                        beta: 1.0, 
                        roe: null,
                        returns: { r1y: calcRet(12), r3y: calcRet(36), r5y: calcRet(60) },
                        technicals: { 
                            high52: meta.fiftyTwoWeekHigh,
                            ma50: meta.fiftyDayAverage,
                            ma200: meta.twoHundredDayAverage
                        }
                    };
                }
            } catch(e) {
                const url = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${yahooSym}`;
                const jsonStr = await fetchWithFallback(url);
                const json = JSON.parse(jsonStr);
                const res = json?.quoteResponse?.result?.[0];
                if(res) {
                    return {
                        name: res.shortName || yahooSym,
                        price: res.regularMarketPrice,
                        type: res.trailingPE ? 'STOCK' : 'ETF',
                        pe: res.trailingPE,
                        beta: res.beta || 1.0,
                        returns: { r1y: 0, r3y: 0, r5y: 0 } 
                    };
                }
            }
            return null;
        }

        async function fetchGoogleFinance(sym) {
            let html = await fetchWithFallback(`https://www.google.com/finance/quote/${sym}:NSE`);
            if (html.includes("Couldn't find")) html = await fetchWithFallback(`https://www.google.com/finance/quote/${sym}:BSE`);
            
            const priceMatch = html.match(/class="YMlKec fxKbKc">₹?([0-9,.]+)</);
            const nameMatch = html.match(/<div class="zzDege">([^<]+)</);
            const rangeMatch = html.match(/Year range.*?<div[^>]*>₹?([0-9,.]+)\s*-\s*₹?([0-9,.]+)/);

            if (priceMatch) {
                const price = parseFloat(priceMatch[1].replace(/,/g, ''));
                let high52 = 0, low52 = 0;
                if(rangeMatch) {
                    low52 = parseFloat(rangeMatch[1].replace(/,/g, ''));
                    high52 = parseFloat(rangeMatch[2].replace(/,/g, ''));
                } else {
                    high52 = price * 1.05; low52 = price * 0.95; 
                }

                return { 
                    name: nameMatch ? nameMatch[1] : sym, 
                    price: price, 
                    type: 'ETF', 
                    pe: null, roe: null, 
                    source: 'Google', 
                    technicals: { high52, low52 }
                };
            }
            return null;
        }

        // --- RENDERING ---
        function renderCard(sym, data, isCached = false) {
            const qty = portfolio[sym].qty || 0;
            const targetContainerId = qty > 0 ? 'view-portfolio' : 'view-watchlist';
            const container = document.getElementById(targetContainerId);
            
            let card = document.getElementById(`card-${sym}`);
            if (!card) {
                card = document.createElement('div');
                card.id = `card-${sym}`;
                container.appendChild(card);
            } else if (card.parentElement.id !== targetContainerId) {
                container.appendChild(card);
            }

            let signal = "HOLD", sigClass = "signal-hold", typeBadge = "badge-stock", metricsHTML = "";
            let sourceTag = data.source === 'Google' ? `<span class="badge-gfin text-[9px] px-1 rounded ml-1">G-FIN</span>` : "";
            const cleanSym = cleanTicker(sym);

            // Calculate Scores
            const fScore = calculateFundamentalScore(data);
            const pScore = calculatePortersScore(data);
            const viewMode = cardViews[sym] || 'fundamental'; // Default view
            let longTermLabel = "";
            
            // Extension: Fundamental Conviction
            const conviction = calculateConviction(fScore, pScore);
            const convictionBadge = getConvictionBadge(conviction);

            // Extension: Business Trajectory
            const trajectory = calculateTrajectory(data);
            const trajectoryBadge = getTrajectoryBadge(trajectory);

            // Extension: Timing Engine
            const timing = calculateTiming(data);
            const timingBadge = getTimingBadge(timing);

            // Extension: Final Decision Synthesizer
            const decision = calculateFinalDecision(conviction, trajectory, timing, data.type);
            const decisionBlock = getDecisionBlock(decision);

            // NEW EXTENSION: Entry-Exit Execution Layer (Moreshwar Sir’s Convention)
            const moreshwarBlock = getMoreshwarBlock(data.price, fScore, pScore, qty > 0, decision.action);

            if(data.type === 'STOCK' && fScore) {
                typeBadge = "badge-stock";
                
                if (fScore.total >= 65) { signal = "BUY"; sigClass = "signal-buy"; }
                else if (fScore.total <= 40) { signal = "SELL"; sigClass = "signal-sell"; }

                // Check for Long Term Potential (Porter > Fundamental)
                if (pScore && pScore.total > fScore.total) {
                    longTermLabel = `<div class="text-[8px] font-semibold bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded border border-purple-200 mt-1 text-right">Long Term Potential</div>`;
                }

                if (qty === 0) {
                    if (signal === "HOLD") signal = "WAIT";
                    if (signal === "SELL") { signal = "AVOID"; sigClass = "signal-gray"; }
                }

                // Explicit Tabs
                const tabHTML = `
                    <div class="flex gap-2 mb-3 mt-1">
                        <button onclick="switchCardTab('${sym}', 'fundamental')" class="analysis-tab ${viewMode === 'fundamental' ? 'active-fund' : 'inactive'}">Fundamental</button>
                        <button onclick="switchCardTab('${sym}', 'porter')" class="analysis-tab ${viewMode === 'porter' ? 'active-port' : 'inactive'}">Porter's 5</button>
                    </div>
                `;

                if (viewMode === 'fundamental') {
                    // FUNDAMENTAL VIEW
                    metricsHTML = `
                        ${tabHTML}
                        <div class="space-y-3 animate-fade-in">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-xs font-bold w-8 text-right">${fScore.total}</span>
                                <div class="flex-1 score-bar-bg h-2">
                                    <div class="score-bar-fill ${fScore.total > 60 ? 'bg-green-500' : (fScore.total < 40 ? 'bg-red-500' : 'bg-yellow-500')}" style="width: ${fScore.total}%"></div>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-[10px]">
                                <div class="bg-gray-50 p-1.5 rounded"><span class="text-gray-400 block">Business</span><span class="font-bold text-gray-700">${fScore.business}/40</span></div>
                                <div class="bg-gray-50 p-1.5 rounded"><span class="text-gray-400 block">Moat</span><span class="font-bold text-gray-700">${fScore.moat}/20</span></div>
                                <div class="bg-gray-50 p-1.5 rounded"><span class="text-gray-400 block">Mgmt</span><span class="font-bold text-gray-700">${fScore.management}/20</span></div>
                                <div class="bg-gray-50 p-1.5 rounded"><span class="text-gray-400 block">Risk</span><span class="font-bold text-gray-700">${fScore.risk}/20</span></div>
                            </div>
                            ${decisionBlock}
                            ${moreshwarBlock}
                        </div>`;
                } else if (viewMode === 'porter') {
                    // PORTER'S VIEW
                    metricsHTML = `
                        ${tabHTML}
                        <div class="space-y-3 animate-fade-in">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-xs font-bold w-8 text-right text-blue-600">${pScore.total}</span>
                                <div class="flex-1 score-bar-bg h-2">
                                    <div class="score-bar-fill bg-blue-500" style="width: ${pScore.total}%"></div>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-[10px]">
                                <div class="bg-blue-50 p-1.5 rounded"><span class="text-gray-400 block">Barriers</span><span class="font-bold text-blue-800">${pScore.entrants}/20</span></div>
                                <div class="bg-blue-50 p-1.5 rounded"><span class="text-gray-400 block">Suppliers</span><span class="font-bold text-blue-800">${pScore.suppliers}/20</span></div>
                                <div class="bg-blue-50 p-1.5 rounded"><span class="text-gray-400 block">Buyers</span><span class="font-bold text-blue-800">${pScore.buyers}/20</span></div>
                                <div class="bg-blue-50 p-1.5 rounded"><span class="text-gray-400 block">Substitutes</span><span class="font-bold text-blue-800">${pScore.substitutes}/20</span></div>
                                <div class="col-span-2 bg-blue-50 p-1.5 rounded flex justify-between"><span class="text-gray-400">Competitive Rivalry</span><span class="font-bold text-blue-800">${pScore.rivalry}/20</span></div>
                            </div>
                            ${decisionBlock}
                            ${moreshwarBlock}
                        </div>`;
                }

            } else if (fScore) {
                // ... existing ETF logic ...
                signal = "SIP"; sigClass = "signal-sip";
                if (fScore.total > 70) signal = "BUY"; 
                
                if (qty === 0) {
                     if (signal === "SIP") { signal = "TRACK"; sigClass = "signal-gray"; }
                }

                typeBadge = data.type === 'ETF' ? "badge-etf" : "badge-fund";
                const isMF = data.type === 'FUND';
                
                let l1="Returns", l2="Momentum", l3="Trend", l4="Safety";
                if(data.explanation === "Trend Strength") { l1="Trend"; l2="Momentum"; l3="Strength"; l4="Support"; }
                else if(isMF) { l1="1Y Ret"; l2="3Y Ret"; l3="5Y Ret"; l4="Trend"; }

                metricsHTML = `
                    <div class="space-y-3">
                         <div class="flex items-center gap-2 mb-2">
                            <span class="text-xs font-bold w-8 text-right">${fScore.total}</span>
                            <div class="flex-1 score-bar-bg h-2">
                                <div class="score-bar-fill bg-blue-500" style="width: ${fScore.total}%"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-[10px]">
                            <div class="bg-gray-50 p-1.5 rounded"><span class="text-gray-400 block">${l1}</span><span class="font-bold text-gray-700">${fScore.business}/40</span></div>
                            <div class="bg-gray-50 p-1.5 rounded"><span class="text-gray-400 block">${l2}</span><span class="font-bold text-gray-700">${fScore.moat}/20</span></div>
                            <div class="bg-gray-50 p-1.5 rounded"><span class="text-gray-400 block">${l3}</span><span class="font-bold text-gray-700">${fScore.management}/20</span></div>
                            <div class="bg-gray-50 p-1.5 rounded"><span class="text-gray-400 block">${l4}</span><span class="font-bold text-gray-700">${fScore.risk}/20</span></div>
                        </div>
                        ${decisionBlock}
                        ${moreshwarBlock}
                    </div>`;
            } else {
                 metricsHTML = ``; 
                 signal = "N/A"; sigClass = "signal-gray";
            }

            stockAnalysis[sym] = { 
                signal, name: data.name, price: data.price, type: data.type, 
                pe: data.pe, growth: data.growth, profitGrowth: data.profitGrowth, opm: data.opm,
                roe: data.roe, mcap: data.mcap, roce: data.roce, beta: data.beta, source: data.source,
                returns: data.returns, technicals: data.technicals
            };
            if(!isCached) saveState(true); 

            const savedQty = portfolio[sym].qty || '';
            const savedAvg = portfolio[sym].avg || '';
            const opacityClass = isCached ? 'updating' : '';

            card.className = `bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden min-h-[340px] flex flex-col relative ${opacityClass}`;
            card.innerHTML = `
                <div class="p-5 flex flex-col h-full">
                    <div class="flex justify-between items-start mb-2">
                        <div class="overflow-hidden">
                            <h3 class="font-bold text-gray-800 text-lg leading-tight truncate w-40" title="${data.name}">${data.name}</h3>
                            <div class="flex gap-2 mt-1 items-center flex-wrap">
                                <span class="text-[10px] font-mono text-gray-500 bg-gray-100 px-1 rounded">${cleanSym}</span>
                                <span class="text-[10px] px-1 rounded font-bold ${typeBadge}">${data.type}</span>
                                ${convictionBadge}
                                ${trajectoryBadge}
                                ${timingBadge}
                                ${sourceTag}
                            </div>
                        </div>
                        <div class="flex flex-col items-end">
                            <div class="text-[10px] font-bold px-2 py-1 rounded border ${sigClass}">${signal}</div>
                            <span class="text-[9px] text-gray-400 mt-1 italic w-20 text-right leading-tight">${fScore?.explanation || ''}</span>
                            ${longTermLabel}
                        </div>
                    </div>

                    <div class="flex justify-between items-end pb-3 border-b border-gray-100 mb-3">
                        <p class="text-2xl font-bold text-gray-800">₹${data.price.toLocaleString()}</p>
                    </div>

                    <div class="bg-gray-50 rounded border border-gray-100 p-2 mb-3">
                        <div class="flex gap-2 mb-1">
                            <div class="flex-1"><label class="text-[9px] text-gray-500 uppercase block mb-1">Qty</label><input type="number" class="portfolio-input" placeholder="0" value="${savedQty}" onchange="updateHolding('${sym}', 'qty', this.value)"></div>
                            <div class="flex-1"><label class="text-[9px] text-gray-500 uppercase block mb-1">Avg</label><input type="number" class="portfolio-input" placeholder="₹" value="${savedAvg}" onchange="updateHolding('${sym}', 'avg', this.value)"></div>
                        </div>
                        <div class="flex justify-between items-center text-xs pt-1"><span class="text-gray-400">P&L:</span><span id="pnl-${sym}" class="font-bold text-gray-300">--</span></div>
                    </div>
                    
                    ${metricsHTML}
                </div>`;
            
            if(!isCached) {
                renderWatchlistItem(sym, false);
                updateCardPnL(sym);
                calculateTotals();
                updateViewCounts();
            } else {
                updateCardPnL(sym);
            }
        }

        // --- UI INTERACTION ---
        window.switchCardTab = function(sym, mode) {
            cardViews[sym] = mode;
            if (stockAnalysis[sym]) {
                // Re-render card with new view state
                renderCard(sym, stockAnalysis[sym], false); // Fixed: Pass false to prevent adding .updating class (locks UI)
                saveState(false); // Save UI state locally
            }
        }

        function createCardSkeleton(sym) {
            const qty = portfolio[sym].qty || 0;
            const containerId = qty > 0 ? 'view-portfolio' : 'view-watchlist';
            const grid = document.getElementById(containerId);
            const card = document.createElement('div');
            card.id = `card-${sym}`;
            card.className = "bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden min-h-[300px] relative";
            card.innerHTML = `<div class="absolute inset-0 flex flex-col items-center justify-center z-10 bg-white/80"><div class="loader mb-2"></div><p class="text-xs text-gray-400">Loading ${cleanTicker(sym)}...</p></div>`;
            grid.insertBefore(card, grid.firstChild);
        }

        function renderWatchlistItem(sym, isLoading) {
            const container = document.getElementById('watchlist-container');
            let item = document.getElementById(`wl-${sym}`);
            const price = livePrices[sym] ? `₹${livePrices[sym].toLocaleString()}` : '--';
            const qty = portfolio[sym].qty || 0;
            const icon = qty > 0 ? '💼' : '👁️'; 
            
            const cleanSym = cleanTicker(sym);

            if (!item) {
                item = document.createElement('div');
                item.id = `wl-${sym}`;
                item.className = "watchlist-item p-3 border-b border-gray-100 hover:bg-gray-50 cursor-pointer flex justify-between items-center group transition-colors";
                item.onclick = () => { 
                    const targetTab = portfolio[sym].qty > 0 ? 'portfolio' : 'watchlist';
                    switchTab(targetTab);
                    setTimeout(() => document.getElementById(`card-${sym}`)?.scrollIntoView({behavior:'smooth'}), 50); 
                };
                container.insertBefore(item, container.firstChild);
            }
            item.innerHTML = isLoading ? 
                `<div><span class="text-sm font-semibold">${cleanSym}</span></div><div class="loader w-3 h-3 border-gray-300 border-t-maroon"></div>` : 
                `<div><span class="mr-2 text-xs opacity-50">${icon}</span><span class="text-sm font-semibold">${cleanSym}</span></div><div class="text-right"><span class="font-mono text-sm">${price}</span><button onclick="event.stopPropagation(); removeStock('${sym}')" class="delete-btn opacity-0 group-hover:opacity-100 text-[10px] text-red-500 uppercase ml-2">Del</button></div>`;
        }

        function renderErrorCard(sym, msg) {
            const qty = portfolio[sym].qty || 0;
            const containerId = qty > 0 ? 'view-portfolio' : 'view-watchlist';
            const container = document.getElementById(containerId);
            let card = document.getElementById(`card-${sym}`);
            if (!card) {
                card = document.createElement('div');
                card.id = `card-${sym}`;
                container.appendChild(card);
            }
            card.innerHTML = `<div class="flex flex-col items-center justify-center h-full p-6 text-center"><span class="text-red-400 font-bold mb-1">Failed</span><span class="text-xs text-gray-400 mb-4 break-words w-full px-4">${msg || "Proxy Error"}</span><button onclick="fetchAsset('${sym}')" class="px-3 py-1 bg-white border border-red-200 text-red-500 text-xs rounded hover:bg-red-50 mb-2">Retry</button><button onclick="removeStock('${sym}')" class="text-xs text-gray-400 underline">Remove</button></div>`;
            const item = document.getElementById(`wl-${sym}`);
            if(item) item.innerHTML = `<span class="text-sm font-semibold text-gray-400">${cleanTicker(sym)}</span><span class="text-xs text-red-500">Error</span>`;
        }

        // --- CORE FUNCTIONS ---
        function processInput() {
            const input = document.getElementById('stockInput');
            const val = input.value.trim().toUpperCase();
            if(!val) return;
            const symbols = val.split(',').map(s => s.trim()).filter(s => s);
            input.value = '';
            document.getElementById('empty-watchlist').classList.add('hidden');
            document.getElementById('main-empty-state').classList.add('hidden');
            symbols.forEach(rawSym => {
                const sym = cleanTicker(rawSym); // Clean key (removes .NS etc)
                if(portfolio[sym]) return;
                portfolio[sym] = { qty: 0, avg: 0 };
                switchTab('watchlist'); 
                renderWatchlistItem(sym, true);
                createCardSkeleton(sym);
                fetchAsset(sym);
            });
            saveState(); 
        }

        function removeStock(sym) {
            delete portfolio[sym]; delete livePrices[sym]; delete stockAnalysis[sym];
            const w = document.getElementById(`wl-${sym}`);
            const c = document.getElementById(`card-${sym}`);
            if(w) w.remove(); if(c) c.remove();
            saveState();
        }

        function clearAll() {
            if(confirm("Clear All?")) {
                portfolio = {}; livePrices = {}; stockAnalysis = {};
                document.getElementById('watchlist-container').innerHTML = `<div id="empty-watchlist" class="p-8 text-center text-gray-400 text-sm italic">Add stocks...</div>`;
                document.getElementById('view-portfolio').innerHTML = '';
                document.getElementById('view-watchlist').innerHTML = '';
                document.getElementById('main-empty-state').classList.remove('hidden');
                saveState();
            }
        }

        function handleEnter(e) { if(e.key === "Enter") processInput(); }
        function updateReqCount() { document.getElementById('requestCounter').style.display = activeRequests > 0 ? 'block' : 'none'; }
        
        window.updateHolding = function(sym, field, val) { 
            if(!portfolio[sym]) return; 
            const oldQty = portfolio[sym].qty;
            portfolio[sym][field] = parseFloat(val) || 0; 
            
            if (field === 'qty') {
                const newQty = portfolio[sym].qty;
                if ((oldQty === 0 && newQty > 0) || (oldQty > 0 && newQty === 0)) {
                    if (stockAnalysis[sym]) renderCard(sym, stockAnalysis[sym]);
                    renderWatchlistItem(sym, false);
                }
            }
            saveState(); 
            updateCardPnL(sym); 
            calculateTotals(); 
        }

        function updateCardPnL(sym) { if(!portfolio[sym] || !livePrices[sym]) return; const qty = portfolio[sym].qty; const avg = portfolio[sym].avg; const cur = livePrices[sym]; const pnl = (qty * cur) - (qty * avg); const el = document.getElementById(`pnl-${sym}`); if(el) { el.innerText = `₹${Math.round(pnl).toLocaleString()}`; el.className = `font-bold text-xs ${pnl >= 0 ? 'text-green-600' : 'text-red-500'}`; } }
        function calculateTotals() { let tInv = 0, tCur = 0; for(let sym in portfolio) { if(livePrices[sym]) { const q = portfolio[sym].qty; tInv += q * portfolio[sym].avg; tCur += q * livePrices[sym]; } } const pnl = tCur - tInv; document.getElementById('total-value').innerText = `₹${Math.round(tCur).toLocaleString()}`; const pnlEl = document.getElementById('total-pnl'); pnlEl.innerText = `₹${Math.round(pnl).toLocaleString()}`; pnlEl.className = `font-bold text-lg leading-tight ${pnl >= 0 ? 'text-green-600' : 'text-red-500'}`; }
        
        function switchTab(tab) { 
            activeTab = tab; 
            saveState(false); 
            const views = { 'portfolio': 'view-portfolio', 'watchlist': 'view-watchlist', 'summary': 'view-summary' };
            const tabs = { 'portfolio': 'tab-portfolio', 'watchlist': 'tab-watchlist', 'summary': 'tab-summary' };
            const es = document.getElementById('main-empty-state');

            if(Object.keys(portfolio).length === 0) {
                Object.values(views).forEach(id => document.getElementById(id).classList.add('hidden'));
                es.classList.remove('hidden');
                return;
            } else {
                es.classList.add('hidden');
            }

            Object.keys(views).forEach(key => {
                const el = document.getElementById(views[key]);
                const btn = document.getElementById(tabs[key]);
                if (key === tab) {
                    el.classList.remove('hidden');
                    btn.className = "tab-active py-1 transition-colors flex items-center gap-2";
                } else {
                    el.classList.add('hidden');
                    btn.className = "tab-inactive py-1 transition-colors flex items-center gap-2";
                }
            });
            if(tab === 'summary') renderSignalSummary();
        }

        function renderSignalSummary() { const listBuy = document.getElementById('list-buy'); const listSip = document.getElementById('list-sip'); const listHold = document.getElementById('list-hold'); listBuy.innerHTML = ''; listSip.innerHTML = ''; listHold.innerHTML = ''; let counts = { BUY: 0, SIP: 0, HOLD: 0 }; Object.entries(stockAnalysis).forEach(([sym, data]) => { let cat = 'HOLD'; if(data.signal === 'BUY') cat = 'BUY'; if(data.type === 'FUND' || data.type === 'ETF') cat = 'SIP'; else if(data.signal === 'SELL' || data.signal === 'AVOID') cat = 'HOLD'; counts[cat]++; const li = document.createElement('div'); li.className = "p-2 bg-gray-50 rounded mb-1 flex justify-between text-xs"; li.innerHTML = `<span class="font-bold">${data.name}</span><span>₹${data.price.toLocaleString()}</span>`; if(cat === 'BUY') listBuy.appendChild(li); else if(cat === 'SIP') listSip.appendChild(li); else listHold.appendChild(li); }); document.getElementById('count-buy').innerText = counts.BUY; document.getElementById('count-sip').innerText = counts.SIP; document.getElementById('count-hold').innerText = counts.HOLD; }
        
        function updateViewCounts() {
            let portCount = 0;
            let watchCount = 0;
            Object.values(portfolio).forEach(p => {
                if (p.qty > 0) portCount++;
                else watchCount++;
            });
            document.getElementById('watchlist-count').innerText = `${Object.keys(portfolio).length} / 50`;
            document.getElementById('badge-port-count').innerText = portCount;
            document.getElementById('badge-watch-count').innerText = watchCount;
            
            document.getElementById('portfolio-empty').style.display = portCount === 0 ? 'flex' : 'none';
            document.getElementById('watchlist-empty').style.display = watchCount === 0 ? 'flex' : 'none';
        }

        // --- EXTENSION MODULE: FUNDAMENTAL CONVICTION ---
        function calculateConviction(fScore, pScore) {
            // Logic for Stocks with Porter's data
            if (pScore) {
                // Combined strength: Average of Fundamental (Internal) and Porter's (External)
                const avg = (fScore.total + pScore.total) / 2;
                if (avg >= 60) return "Strong";
                if (avg <= 40) return "Weak";
                return "Stable";
            }
            
            // Logic for Funds/ETFs (Fundamental only)
            if (fScore.total >= 65) return "Strong";
            if (fScore.total <= 40) return "Weak";
            return "Stable";
        }

        function getConvictionBadge(label) {
            if (!label) return '';
            const styles = {
                'Strong': 'bg-emerald-100 text-emerald-800 border-emerald-200',
                'Stable': 'bg-amber-100 text-amber-800 border-amber-200',
                'Weak': 'bg-rose-100 text-rose-800 border-rose-200'
            };
            return `<span class="text-[9px] font-bold px-1.5 py-0.5 rounded border ${styles[label]} uppercase tracking-wider mx-1">${label}</span>`;
        }

        // --- EXTENSION MODULE: BUSINESS TRAJECTORY ---
        function calculateTrajectory(data) {
            if (data.type !== 'STOCK') return null;
            
            const sales = data.growth || 0;
            const profit = data.profitGrowth || 0;
            const roe = data.roe || 0;

            // Red Flags
            if (sales < 0 || profit < 0) return "Deteriorating";
            if (profit < 5 && sales < 5) return "Deteriorating"; // Stagnation

            // Green Flags
            // 1. Operating Leverage (Margins expanding) + Healthy Growth
            if (profit > sales && sales > 5 && profit > 10) return "Improving";
            
            // 2. High Performance compounder
            if (roe > 20 && profit > 10) return "Improving";

            return "Flat";
        }

        function getTrajectoryBadge(label) {
            if (!label) return '';
            const styles = {
                'Improving': 'bg-indigo-100 text-indigo-800 border-indigo-200',
                'Flat': 'bg-gray-100 text-gray-600 border-gray-200',
                'Deteriorating': 'bg-orange-100 text-orange-800 border-orange-200'
            };
            return `<span class="text-[9px] font-bold px-1.5 py-0.5 rounded border ${styles[label]} uppercase tracking-wider mx-1">${label}</span>`;
        }

        // --- EXTENSION MODULE: TIMING ENGINE (Lightweight/Binary) ---
        function calculateTiming(data) {
            const price = data.price || 0;
            const r1y = data.returns?.r1y || 0;
            const r3y = data.returns?.r3y || 0;
            const ma200 = data.technicals?.ma200 || 0; // Available for ETFs, sometimes missing for Stocks

            // 1. Determine Trend Direction
            let trend = 'Neutral';
            if (ma200 > 0) {
                // If we have MA200 (Technically rigorous)
                trend = price > ma200 ? 'Up' : 'Down';
            } else {
                // Fallback: Use 1Y Return sign (Simple momentum)
                if (r1y > 10) trend = 'Up';
                else if (r1y < -5) trend = 'Down';
            }

            // 2. Determine Momentum Status (Derivative)
            // Is the trend accelerating or decelerating?
            let momentum = 'Stable';
            if (r1y > r3y + 5) momentum = 'Improving'; // 1Y performance beating 3Y avg
            else if (r1y < r3y - 5) momentum = 'Weakening';

            // 3. Synthesis Output
            if (trend === 'Up' && momentum === 'Improving') return "Favourable";
            if (trend === 'Down' && momentum === 'Weakening') return "Unfavourable";
            
            // Mixed Cases
            if (trend === 'Up' && momentum === 'Weakening') return "Neutral"; // Up but losing steam
            if (trend === 'Down' && momentum === 'Improving') return "Neutral"; // Down but recovering
            
            // Default flat/stable
            if (r1y > 0) return "Neutral";
            return "Unfavourable";
        }

        function getTimingBadge(label) {
            if (!label) return '';
            const styles = {
                'Favourable': 'bg-teal-100 text-teal-800 border-teal-200',
                'Neutral': 'bg-slate-100 text-slate-600 border-slate-200',
                'Unfavourable': 'bg-red-100 text-red-800 border-red-200'
            };
            return `<span class="text-[9px] font-bold px-1.5 py-0.5 rounded border ${styles[label]} uppercase tracking-wider mx-1">TIMING: ${label}</span>`;
        }

        // --- EXTENSION MODULE: FINAL DECISION SYNTHESIZER ---
        function calculateFinalDecision(conviction, trajectory, timing, type) {
            let action = "WAIT";
            let summary = "";

            // Handle ETF/Funds slightly differently (Trajectory might be null)
            const isFund = type !== 'STOCK';
            const effTrajectory = isFund ? (timing === 'Favourable' ? 'Improving' : 'Flat') : trajectory;

            // 1. AVOID Logic
            if (conviction === 'Weak') {
                action = "AVOID";
                summary = "The fundamental quality does not meet the required threshold for investment. The business risks currently outweigh the potential rewards. It is safer to look for better opportunities elsewhere.";
            }
            // 2. WAIT Logic (Deteriorating)
            else if (effTrajectory === 'Deteriorating') {
                action = "WAIT";
                summary = "While the company has history, recent performance suggests a slowdown in business momentum. Fundamental trends are cooling off, which requires patience. It is best to watch from the sidelines until growth stabilizes.";
            }
            // 3. BUY NOW Logic (The Perfect Setup)
            else if (conviction === 'Strong' && effTrajectory === 'Improving' && timing === 'Favourable') {
                action = "BUY NOW";
                summary = "The company is showing high quality and accelerating business performance. Market trends are also aligning with these strong fundamentals. This offers a prime opportunity to enter or add aggressively.";
            }
            // 4. SIP ONLY Logic (Quality but bad timing or flat growth)
            else if (conviction === 'Strong') {
                action = "SIP ONLY";
                summary = "This is a high-quality asset, though immediate momentum is not yet perfectly aligned. The long-term story remains intact despite short-term market noise. Accumulating slowly allows you to build a position without timing risk.";
            }
            // 5. Stable Logic
            else if (conviction === 'Stable') {
                if (timing === 'Unfavourable') {
                    action = "WAIT";
                    summary = "The business is stable, but the price is currently under pressure. There is no urgency to buy as the trend is negative. Wait for the selling pressure to subside before acting.";
                } else {
                    action = "SIP ONLY";
                    summary = "The asset demonstrates acceptable stability without being exceptional. Current trends support a moderate allocation strategy. Regular, small investments are the best way to handle this steady performer.";
                }
            }

            return { action, summary };
        }

        function getDecisionBlock(decision) {
            const colors = {
                'BUY NOW': 'bg-green-50 border-green-200 text-green-800',
                'SIP ONLY': 'bg-blue-50 border-blue-200 text-blue-800',
                'WAIT': 'bg-orange-50 border-orange-200 text-orange-800',
                'AVOID': 'bg-red-50 border-red-200 text-red-800'
            };
            const colorClass = colors[decision.action] || 'bg-gray-50 border-gray-200';
            
            return `
                <div class="mt-3 pt-3 border-t border-dashed border-gray-200">
                    <div class="flex items-center justify-between mb-1">
                        <span class="text-[9px] font-bold text-gray-400 uppercase tracking-widest">Final Verdict</span>
                        <span class="text-[10px] font-bold px-2 py-0.5 rounded border ${colorClass}">${decision.action}</span>
                    </div>
                    <p class="text-[10px] text-gray-500 italic leading-relaxed">"${decision.summary}"</p>
                </div>
            `;
        }

        // --- EXTENSION MODULE: ENTRY-EXIT EXECUTION LAYER (Moreshwar Sir’s Convention) ---
        function calculateMoreshwarLevels(price, fScore, pScore, isHolding) {
            // Conviction score X
            const scoreSum = pScore ? (fScore.total + pScore.total) : fScore.total;
            const count = pScore ? 2 : 1;
            const X = Math.round(scoreSum / count); // Keep score generic logic consistent
            
            // Current Price Y
            const Y = price;

            let result = { target: null, sl: null, entry: null };

            if (isHolding) {
                // For Portfolio Holdings
                // Target = Y + X
                // Stop-loss = 100 - X
                result.target = Y + X;
                result.sl = 100 - X;
            } else {
                // For Watchlist (Pre-Entry)
                // Entry level = 100 - X
                result.entry = 100 - X;
            }
            return result;
        }

        function getMoreshwarBlock(price, fScore, pScore, isHolding, decisionAction) {
            // Activation Rule: Only if BUY NOW or SIP ONLY
            if (decisionAction !== 'BUY NOW' && decisionAction !== 'SIP ONLY') return '';

            const levels = calculateMoreshwarLevels(price, fScore, pScore, isHolding);
            
            // Render logic
            let html = `<div class="mt-2 pt-2 border-t border-gray-100 flex justify-between items-center text-[10px] font-mono text-gray-600 bg-gray-50/50 p-2 rounded">`;
            
            if (isHolding) {
                html += `
                    <div class="flex flex-col">
                        <span class="text-[8px] text-gray-400 uppercase">Target (Y+X)</span>
                        <span class="font-bold text-green-600">₹${levels.target.toLocaleString()}</span>
                    </div>
                    <div class="flex flex-col text-right">
                        <span class="text-[8px] text-gray-400 uppercase">Stop-loss (100-X)</span>
                        <span class="font-bold text-red-600">${levels.sl.toLocaleString()}</span>
                    </div>
                `;
            } else {
                html += `
                    <div class="flex flex-col w-full text-center">
                        <span class="text-[8px] text-gray-400 uppercase">Entry Level (100-X)</span>
                        <span class="font-bold text-blue-600">${levels.entry.toLocaleString()}</span>
                    </div>
                `;
            }
            html += `</div>`;
            return html;
        }
    </script>
</body>
</html>
