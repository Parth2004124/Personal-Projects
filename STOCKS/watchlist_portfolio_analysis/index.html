<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="referrer" content="no-referrer">
    <title>StockSight Cloud</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .text-maroon { color: #800000; }
        .bg-maroon { background-color: #800000; }
        .border-maroon { border-color: #800000; }
        .custom-scroll::-webkit-scrollbar { width: 6px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 3px; }
        .loader {
            border: 2px solid #f3f3f3;
            border-top: 2px solid #800000;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .signal-buy { color: #10B981; background: #ECFDF5; border: 1px solid #10B981; }
        .signal-sell { color: #EF4444; background: #FEF2F2; border: 1px solid #EF4444; }
        .signal-hold { color: #F59E0B; background: #FFFBEB; border: 1px solid #F59E0B; }
        .signal-sip { color: #3B82F6; background: #EFF6FF; border: 1px solid #3B82F6; }
        .signal-gray { color: #6B7280; background: #F3F4F6; border: 1px solid #E5E7EB; }
        .watchlist-item:hover .delete-btn { opacity: 1; }
        .portfolio-input {
            width: 100%;
            padding: 4px;
            border: 1px solid #e5e7eb;
            border-radius: 4px;
            font-size: 12px;
            text-align: right;
            background: #f9fafb;
        }
        .portfolio-input:focus { outline: 1px solid #800000; background: white; }
        .tab-active { border-bottom: 2px solid #800000; color: #800000; font-weight: 600; }
        .tab-inactive { color: #6b7280; border-bottom: 2px solid transparent; }
        .tab-inactive:hover { color: #374151; border-bottom: 2px solid #e5e7eb; }
        .badge-stock { background: #e0e7ff; color: #3730a3; }
        .badge-fund { background: #fef3c7; color: #92400e; }
        .badge-etf { background: #dcfce7; color: #166534; }
        .badge-gfin { background: #fee2e2; color: #991b1b; } 
        .updating { opacity: 0.6; pointer-events: none; filter: grayscale(0.5); }
        .score-bar-bg { background-color: #e5e7eb; height: 6px; border-radius: 3px; overflow: hidden; }
        .score-bar-fill { height: 100%; border-radius: 3px; }
        
        /* Analysis Tabs */
        .analysis-tab { font-size: 10px; padding: 2px 8px; border-radius: 12px; cursor: pointer; transition: all 0.2s; border: 1px solid transparent; }
        .analysis-tab.active-fund { background: #fee2e2; color: #800000; border-color: #fecaca; font-weight: 600; }
        .analysis-tab.active-port { background: #dbeafe; color: #1e40af; border-color: #bfdbfe; font-weight: 600; }
        .analysis-tab.inactive { background: white; color: #9ca3af; border-color: #e5e7eb; }
        .analysis-tab.inactive:hover { background: #f9fafb; color: #4b5563; }
    </style>
</head>
<body class="h-screen flex flex-col md:flex-row overflow-hidden text-gray-800">

    <!-- SIDEBAR -->
    <aside class="w-full md:w-80 bg-white border-r border-gray-200 flex flex-col z-20 shadow-lg shrink-0 h-1/3 md:h-full">
        <div class="p-4 border-b border-gray-200 bg-white">
            <div class="flex justify-between items-center mb-3">
                <h1 class="font-bold text-gray-800 tracking-tight flex items-center gap-2">
                    <span class="w-2 h-2 rounded-full bg-maroon"></span>
                    Terminal
                </h1>
                <div class="flex items-center gap-2">
                    <button onclick="forceSync()" class="text-gray-400 hover:text-maroon transition" title="Force Cloud Sync">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
                    </button>
                    <span id="watchlist-count" class="text-xs text-gray-400 font-mono">0 / 50</span>
                </div>
            </div>
            <div class="relative space-y-2">
                <div class="relative">
                    <input type="text" id="stockInput" 
                        class="w-full pl-8 pr-16 py-2 border border-gray-300 rounded text-sm focus:outline-none focus:border-maroon focus:ring-1 focus:ring-maroon uppercase"
                        placeholder="Symbol (INFY) or MF Code"
                        onkeypress="handleEnter(event)">
                    <svg class="w-4 h-4 text-gray-400 absolute left-2.5 top-2.5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                    <button onclick="processInput()" class="absolute right-1 top-1 bottom-1 px-3 bg-gray-100 hover:bg-gray-200 text-xs font-semibold rounded text-gray-600">Add</button>
                </div>
            </div>
        </div>

        <div id="watchlist-container" class="flex-1 overflow-y-auto custom-scroll">
            <div id="empty-watchlist" class="p-8 text-center text-gray-400 text-sm italic">
                <div class="loader mx-auto mb-2"></div>
                Connecting to Google Sheets...
            </div>
        </div>

        <div class="p-3 bg-gray-50 border-t border-gray-200 text-xs flex justify-between text-gray-500 items-center">
            <div id="cloud-status" class="flex items-center gap-2 cursor-pointer" onclick="forceSync()" title="Click to Retry Connection">
                <span class="w-2 h-2 rounded-full bg-gray-400"></span>
                <span>Connecting...</span>
            </div>
            <div id="requestCounter" class="hidden text-maroon font-semibold">Updating...</div>
        </div>
    </aside>

    <!-- MAIN DASHBOARD -->
    <main class="flex-1 overflow-y-auto custom-scroll bg-gray-100 flex flex-col h-2/3 md:h-full relative">
        
        <!-- Top Bar -->
        <div class="bg-white border-b border-gray-200 px-6 py-4 shadow-sm flex flex-wrap justify-between items-center gap-4 sticky top-0 z-10">
            <div class="flex items-center gap-6">
                <!-- TABS -->
                <div class="flex space-x-6 text-sm font-medium">
                    <button id="tab-portfolio" onclick="switchTab('portfolio')" class="tab-active py-1 transition-colors flex items-center gap-2">
                        <span>My Portfolio</span>
                        <span id="badge-port-count" class="bg-red-100 text-maroon text-[10px] px-1.5 py-0.5 rounded-full">0</span>
                    </button>
                    <button id="tab-watchlist" onclick="switchTab('watchlist')" class="tab-inactive py-1 transition-colors flex items-center gap-2">
                        <span>Watchlist</span>
                        <span id="badge-watch-count" class="bg-gray-100 text-gray-500 text-[10px] px-1.5 py-0.5 rounded-full">0</span>
                    </button>
                    <button id="tab-summary" onclick="switchTab('summary')" class="tab-inactive py-1 transition-colors">Analytics</button>
                </div>
            </div>

            <div class="flex gap-6 text-sm">
                <div class="text-right">
                    <p class="text-[10px] text-gray-500 uppercase font-semibold">Current Value</p>
                    <p id="total-value" class="font-bold text-gray-800 text-lg leading-tight">₹0</p>
                </div>
                <div class="text-right">
                    <p class="text-[10px] text-gray-500 uppercase font-semibold">Total P&L</p>
                    <p id="total-pnl" class="font-bold text-gray-400 text-lg leading-tight">₹0</p>
                </div>
            </div>
        </div>

        <!-- Global Error -->
        <div id="globalError" class="hidden m-4 bg-red-50 border-l-4 border-red-500 text-red-700 p-4 text-sm rounded shadow-sm">
            <p class="font-bold">Fetch Error</p>
            <p id="globalErrorMsg">Unable to fetch data.</p>
        </div>

        <!-- TAB 1: PORTFOLIO GRID -->
        <div id="view-portfolio" class="p-4 md:p-6 grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
            <div id="portfolio-empty" class="col-span-full hidden flex-col items-center justify-center text-gray-400 py-12">
                <p>No holdings yet.</p>
                <p class="text-xs">Add Qty to a watchlist item to move it here.</p>
            </div>
        </div>

        <!-- TAB 2: WATCHLIST GRID -->
        <div id="view-watchlist" class="hidden p-4 md:p-6 grid grid-cols-1 lg:grid-cols-2 xl:grid-cols-3 gap-6">
            <div id="watchlist-empty" class="col-span-full hidden flex-col items-center justify-center text-gray-400 py-12">
                <p>Watchlist empty.</p>
                <p class="text-xs">Use the sidebar to search and add stocks.</p>
            </div>
        </div>

        <!-- TAB 3: PORTFOLIO SUMMARY -->
        <div id="view-summary" class="hidden p-4 md:p-6 flex-col gap-6 h-full items-start">
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-4 gap-6 w-full">
                <!-- COL 1: Allocation -->
                <div class="bg-gradient-to-br from-indigo-50 to-white rounded-lg border border-indigo-100 shadow-sm overflow-hidden h-fit flex flex-col">
                    <div class="px-5 py-4 border-b border-indigo-100/50 flex justify-between items-center">
                        <h3 class="text-indigo-900 font-bold text-sm uppercase tracking-wide">Asset Allocation</h3>
                        <div class="p-1.5 bg-indigo-100 rounded-full text-indigo-600">
                           <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.001 9.001 0 1020.945 13H11V3.055z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M20.488 9H15V3.512A9.025 9.025 0 0120.488 9z"></path></svg>
                        </div>
                    </div>
                    <div id="analytics-allocation" class="p-6 flex-1 flex flex-col justify-center">
                        <div class="loader mx-auto mb-2 border-indigo-200 border-t-indigo-600"></div>
                        <span class="text-xs text-indigo-400 text-center">Analyzing...</span>
                    </div>
                </div>
                
                <!-- COL 2: Performance -->
                <div class="bg-gradient-to-br from-emerald-50 to-white rounded-lg border border-emerald-100 shadow-sm overflow-hidden h-fit flex flex-col">
                     <div class="px-5 py-4 border-b border-emerald-100/50 flex justify-between items-center">
                        <h3 class="text-emerald-900 font-bold text-sm uppercase tracking-wide">Performance</h3>
                         <div class="p-1.5 bg-emerald-100 rounded-full text-emerald-600">
                           <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6"></path></svg>
                        </div>
                    </div>
                    <div id="analytics-performance" class="p-6 flex-1 flex flex-col justify-center">
                         <div class="loader mx-auto mb-2 border-emerald-200 border-t-emerald-600"></div>
                         <span class="text-xs text-emerald-400 text-center">Calculating...</span>
                    </div>
                </div>
                
                <!-- COL 3: Health -->
                <div class="bg-gradient-to-br from-amber-50 to-white rounded-lg border border-amber-100 shadow-sm overflow-hidden h-fit flex flex-col">
                    <div class="px-5 py-4 border-b border-amber-100/50 flex justify-between items-center">
                        <h3 class="text-amber-900 font-bold text-sm uppercase tracking-wide">Portfolio Health</h3>
                         <div class="p-1.5 bg-amber-100 rounded-full text-amber-600">
                           <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                        </div>
                    </div>
                    <div id="analytics-health" class="p-6 flex-1 flex flex-col justify-center">
                         <div class="loader mx-auto mb-2 border-amber-200 border-t-amber-600"></div>
                         <span class="text-xs text-amber-400 text-center"> diagnosing...</span>
                    </div>
                </div>
    
                <!-- COL 4: Actions -->
                <div class="bg-gradient-to-br from-violet-50 to-white rounded-lg border border-violet-100 shadow-sm overflow-hidden h-fit flex flex-col">
                    <div class="px-5 py-4 border-b border-violet-100/50 flex justify-between items-center">
                        <h3 class="text-violet-900 font-bold text-sm uppercase tracking-wide">Action Plan</h3>
                        <div class="p-1.5 bg-violet-100 rounded-full text-violet-600">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                        </div>
                    </div>
                    <div id="analytics-actions" class="p-6 flex-1 flex flex-col gap-2">
                    <div class="loader mx-auto mb-2 border-violet-200 border-t-violet-600"></div>
                    <span class="text-xs text-violet-400 text-center">Scanning...</span>
                </div>
            </div>
        </div>
            
            <!-- // SUPPORT-DOCS: Footer Button in Analytics Pane -->
            <div class="w-full flex justify-end mt-4 mb-8">
                <button onclick="toggleSupportView()" class="text-[10px] text-gray-400 hover:text-gray-600 transition-colors flex items-center gap-1">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Support & Methodology
                </button>
            </div>
        </div>

        <!-- // SUPPORT-DOCS: Internal Documentation View (Hidden by default) -->
        <div id="view-support" class="hidden p-6 md:p-8 bg-white h-full overflow-y-auto custom-scroll">
            <div class="max-w-2xl mx-auto">
                <button onclick="toggleSupportView()" class="mb-6 text-xs font-semibold text-gray-500 hover:text-gray-800 flex items-center gap-1">
                    <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                    Back to Analytics
                </button>
                
                <h1 class="text-xl font-bold text-gray-800 mb-2">System Methodology</h1>
                <p class="text-sm text-gray-600 mb-8 leading-relaxed">
                    This terminal evaluates portfolio structure using deterministic, rule-based algorithms. It does not provide financial advice, forecasts, or price predictions. All outputs are derived strictly from current asset data.
                </p>

                <div class="space-y-8">
                    <div>
                        <h2 class="font-bold text-gray-800 text-sm uppercase tracking-wide mb-3 border-b border-gray-100 pb-1">1. Scoring Philosophy</h2>
                        <div class="text-xs text-gray-600 space-y-2">
                            <p><span class="font-semibold text-gray-700">Deterministic Logic:</span> Scores (0-100) are calculated using fixed thresholds for growth, profitability, and valuation. No discretionary judgment is applied.</p>
                            <p><span class="font-semibold text-gray-700">Multi-Factor Engine:</span>
                                <ul class="list-disc pl-4 mt-1 space-y-1">
                                    <li><b>Business Quality (40%):</b> Sales growth, Profit growth, and Operating Margins.</li>
                                    <li><b>Moat (20%):</b> Return on Capital (ROCE), Return on Equity (ROE), and Market Dominance.</li>
                                    <li><b>Management (20%):</b> Capital allocation efficiency proxied by valuation relative to growth (PEG-like logic) and P/E bands.</li>
                                    <li><b>Risk (20%):</b> Volatility (Beta), Market Cap stability, and Technical Support levels.</li>
                                </ul>
                            </p>
                        </div>
                    </div>

                    <div>
                        <h2 class="font-bold text-gray-800 text-sm uppercase tracking-wide mb-3 border-b border-gray-100 pb-1">2. Industry-Aware Normalization</h2>
                        <div class="text-xs text-gray-600 space-y-2">
                            <p>Raw financial ratios vary by sector. The system applies a normalization layer to prevent unfair penalization:</p>
                            <ul class="list-disc pl-4 mt-1 space-y-1">
                                <li><b>Banking/NBFC:</b> Focus shifts to ROE and Loan Growth. OPM (Operating Margin) is ignored as it is irrelevant for lending businesses.</li>
                                <li><b>IT Services:</b> Higher weightage on Margins (OPM) and efficiency.</li>
                                <li><b>FMCG:</b> Premiums awarded for high ROCE and brand stability.</li>
                                <li><b>Cyclicals (Auto/Power):</b> Growth thresholds are adjusted to account for economic cycles; recent turnaround signals are prioritized over trailing 3-year averages.</li>
                            </ul>
                        </div>
                    </div>

                    <div>
                        <h2 class="font-bold text-gray-800 text-sm uppercase tracking-wide mb-3 border-b border-gray-100 pb-1">3. Portfolio Analytics</h2>
                        <div class="text-xs text-gray-600 space-y-2">
                            <p><span class="font-semibold text-gray-700">Capital Efficiency:</span> Checks if capital is deployed effectively.
                                <br>- <i>"Capital Trap":</i> High allocation (>10%) in a low-score asset (<50).
                                <br>- <i>"Under-allocated":</i> Low allocation (<3%) in a high-conviction asset (>70).
                            </p>
                            <p><span class="font-semibold text-gray-700">Risk Concentration:</span> Flags single-asset exposure >20% or single-sector exposure >35%.</p>
                            <p><span class="font-semibold text-gray-700">Drawdown Sensitivity:</span> Estimates portfolio volatility based on weighted Beta. "Defensive" implies lower volatility than the market; "Aggressive" implies higher.</p>
                        </div>
                    </div>

                    <div>
                        <h2 class="font-bold text-gray-800 text-sm uppercase tracking-wide mb-3 border-b border-gray-100 pb-1">4. APTE Conviction (Porter's Logic)</h2>
                        <div class="text-xs text-gray-600 space-y-2">
                            <p>This module translates quantitative metrics into qualitative competitive advantages:</p>
                            <ul class="list-disc pl-4 mt-1 space-y-1">
                                <li><b>Barriers to Entry:</b> High Market Cap + High ROCE implies scale and efficiency that is hard to replicate.</li>
                                <li><b>Supplier Power:</b> High Operating Margins (OPM) suggest the company dictates pricing, not its suppliers.</li>
                                <li><b>Buyer Power:</b> High Return on Equity (ROE) indicates strong brand loyalty or switching costs.</li>
                                <li><b>Threat of Substitutes:</b> Consistent double-digit Sales Growth implies the product is essential or unique.</li>
                                <li><b>Competitive Rivalry:</b> Rising Profit Growth in a crowded market signals a "Winner Takes All" capability.</li>
                            </ul>
                        </div>
                    </div>

                    <div>
                        <h2 class="font-bold text-gray-800 text-sm uppercase tracking-wide mb-3 border-b border-gray-100 pb-1">5. Entry & Exit Logic</h2>
                        <div class="text-xs text-gray-600 space-y-2">
                            <p><span class="font-semibold text-gray-700">Score Thresholds:</span>
                                <ul class="list-disc pl-4 mt-1 space-y-1">
                                    <li><b>Score ≥ 65 (Strong):</b> Triggers a <span class="text-green-600 font-bold">BUY</span> signal. Indicates high quality + reasonable valuation.</li>
                                    <li><b>Score ≤ 40 (Weak):</b> Triggers a <span class="text-red-600 font-bold">SELL</span> signal. Indicates deterioration in fundamentals or extreme overvaluation.</li>
                                    <li><b>41 - 64 (Moderate):</b> Triggers <span class="text-yellow-600 font-bold">HOLD</span> or <span class="text-gray-500 font-bold">WAIT</span>. Action depends on trend trajectory.</li>
                                </ul>
                            </p>
                            <p><span class="font-semibold text-gray-700">Dynamic Price Levels (Moreshwar Model):</span>
                                <br>Levels are derived directly from the conviction score (X):
                                <br>- <i>Target:</i> Current Price + X (Higher conviction = Higher target upside).
                                <br>- <i>Stop Loss / Entry:</i> Current Price - (100 - X). (Lower conviction = Wider safety margin required).
                            </p>
                        </div>
                    </div>

                    <div class="bg-gray-50 p-4 rounded border border-gray-100">
                        <h3 class="font-bold text-gray-700 text-xs mb-1">Disclaimer</h3>
                        <p class="text-[10px] text-gray-500 leading-normal">
                            This system is an analytical tool for structural evaluation only. It calculates scores based on past performance and current valuation. It does not predict future stock prices. The "Action Plan" suggests structural adjustments based on rule compliance, not trading advice.
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <div id="main-empty-state" class="flex-1 flex flex-col items-center justify-center text-gray-300 p-10 hidden">
            <p class="text-lg font-medium text-gray-400">Loading Portfolio...</p>
        </div>

    </main>

    <script>
        // --- GOOGLE SHEET CONFIG ---
        const SHEET_API_URL = "https://script.google.com/macros/s/AKfycbyScFGyxqSwudrvbCngaPtlKxtHlS4O8Q7bj4FcQEESir3LFSlnHquPxskKsBKC9kS1VQ/exec";

        // --- STATE ---
        let portfolio = {}; 
        let livePrices = {}; 
        let stockAnalysis = {}; 
        let cardViews = {}; 
        let activeTab = 'portfolio';
        let saveTimeout = null;
        let isOfflineMode = false;
        let activeRequests = 0;
        let portfolioAnalytics = { healthScore: 0, scoredValue: 0, totalValue: 0, allocation: {}, risk: {}, efficiency: [] };
        
        // --- KEYS FILTER ---
        const BLACKLIST_KEYS = ['status', 'message', 'result', 'sync-ts', 'sync_ts', 'version', 'timestamp'];

        // --- INDUSTRY-NORMALIZATION CONFIGURATION ---
        const INDUSTRY_PROFILES = {
            'BANKING': { 
                keywords: ['BANK', 'FINANCE', 'CAPITAL', 'HOLDINGS', 'INVEST', 'BAJAJ', 'HDFC', 'ICICI', 'KOTAK', 'AXIS', 'SBI', 'CHOLA', 'MUTHOOT'], 
                weights: { business: 1.1, moat: 1.2, management: 1.0, risk: 0.9 }, 
                required: ['roe'] 
            },
            'IT': { 
                keywords: ['TECH', 'INFOSYS', 'TCS', 'WIPRO', 'HCL', 'MINDTREE', 'LTIM', 'PERSISTENT', 'COFORGE', 'SYSTEMS', 'SOFTWARE', 'DATA'], 
                weights: { business: 1.2, moat: 1.0, management: 1.1, risk: 1.0 }, 
                required: ['opm'] 
            },
            'FMCG': { 
                keywords: ['HUL', 'NESTLE', 'BRITANNIA', 'DABUR', 'GODREJ', 'MARICO', 'TATA CONSUMER', 'ITC', 'FOODS', 'CONSUMER', 'VARUN'],
                weights: { business: 1.0, moat: 1.3, management: 1.1, risk: 1.0 }, 
                required: ['roce']
            },
            'PHARMA': { 
                keywords: ['PHARMA', 'LAB', 'DRUG', 'REDDY', 'SUN', 'CIPLA', 'DIVIS', 'LUPIN', 'ALKEM', 'TORRENT'],
                weights: { business: 1.1, moat: 1.0, management: 1.0, risk: 0.9 },
                required: []
            },
            'AUTO': {
                keywords: ['MOTOR', 'AUTO', 'MARUTI', 'MAHINDRA', 'TATA MOTORS', 'EICHER', 'BAJAJ AUTO', 'TVS'],
                weights: { business: 1.2, moat: 0.9, management: 1.0, risk: 0.9 },
                required: []
            },
            'POWER': {
                keywords: ['POWER', 'ENERGY', 'NTPC', 'ADANI', 'GRID', 'TATA POWER', 'NHPC', 'JSW ENERGY'],
                weights: { business: 1.0, moat: 1.2, management: 0.9, risk: 0.8 },
                required: []
            },
            'REAL_ESTATE': {
                keywords: ['REALTY', 'DLF', 'GODREJ PROP', 'OBEROI', 'PRESTIGE', 'LODHA', 'MACROTECH'],
                weights: { business: 1.1, moat: 0.8, management: 1.0, risk: 0.8 },
                required: []
            },
            'GENERAL': {
                keywords: [],
                weights: { business: 1.0, moat: 1.0, management: 1.0, risk: 1.0 },
                required: []
            }
        };

        // --- HELPER FUNCTIONS ---
        function cleanTicker(sym) {
            if(!sym) return '';
            return sym.replace(/\.NS$/, '').replace(/\.BO$/, '').replace(/:NSE$/, '').replace(/:BSE$/, '');
        }

        function getDisplayName(sym) {
            return stockAnalysis[sym]?.name || cleanTicker(sym);
        }

        function sanitizePortfolio(raw) {
            const clean = {};
            if (!raw) return clean;
            Object.keys(raw).forEach(key => {
                const k = key.toLowerCase();
                if (BLACKLIST_KEYS.includes(k)) return;
                if (typeof raw[key] !== 'object' || raw[key] === null) return;
                if (key.length > 20 || key.includes(' ')) return; 
                clean[key] = raw[key];
            });
            return clean;
        }

        function updateCloudStatus(status, text) {
            const el = document.getElementById('cloud-status');
            if(!el) return;
            let color = 'bg-gray-400';
            if (status === 'loading') color = 'bg-yellow-400 animate-pulse';
            if (status === 'success') color = 'bg-green-500';
            if (status === 'error') color = 'bg-red-500';
            el.innerHTML = `<span class="w-2 h-2 rounded-full ${color}"></span><span>${text}</span>`;
        }

        function updateReqCount() {
            const el = document.getElementById('requestCounter');
            if(el) el.style.display = activeRequests > 0 ? 'block' : 'none';
        }

        function calculateMFReturns(history) {
            if(!history || !Array.isArray(history) || history.length < 10) return { r1y:0, r3y:0, r5y:0 };
            const now = parseFloat(history[0].nav);
            const parseDate = (dStr) => { 
                const [d, m, y] = dStr.split('-'); 
                return new Date(`${y}-${m}-${d}`); 
            };
            const findNavAgo = (years) => {
                const targetDate = new Date();
                targetDate.setFullYear(targetDate.getFullYear() - years);
                const entry = history.find(h => parseDate(h.date) <= targetDate);
                return entry ? parseFloat(entry.nav) : null;
            };
            const r1yNav = findNavAgo(1); 
            const r3yNav = findNavAgo(3); 
            const r5yNav = findNavAgo(5);
            const cagr = (end, start, years) => ((Math.pow(end/start, 1/years) - 1) * 100);
            return { 
                r1y: r1yNav ? cagr(now, r1yNav, 1) : 0, 
                r3y: r3yNav ? cagr(now, r3yNav, 3) : 0, 
                r5y: r5yNav ? cagr(now, r5yNav, 5) : 0 
            };
        }

        // --- SCORING ENGINE 1: FUNDAMENTAL ---
        function calculateFundamentalScore(data) {
            let scores = { business: 0, moat: 0, management: 0, risk: 0, total: 0, explanation: "" };
            let reasons = [];
            
            if (data.type === 'FUND' || data.type === 'ETF') {
                const ret1y = data.returns?.r1y || 0;
                const ret3y = data.returns?.r3y || 0;
                const ret5y = data.returns?.r5y || 0;
                const price = data.price || 0;
                const high52 = data.technicals?.high52 || price;
                
                if (data.type === 'FUND' || (data.source !== 'Google' && ret1y !== 0)) {
                      let totalScore = 0;
                      if (ret1y > 15) totalScore += 40; else if (ret1y > 10) totalScore += 30; else if (ret1y > 0) totalScore += 15;
                      if (ret3y > 12) totalScore += 30; else if (ret3y > 8) totalScore += 20; else if (ret3y > 0) totalScore += 10;
                      if (ret5y > 10) totalScore += 30; else if (ret5y > 8) totalScore += 20; else if (ret5y > 0) totalScore += 10;
                      
                      scores.total = Math.min(99, totalScore);
                      scores.business = Math.min(40, Math.round(totalScore * 0.4));
                      scores.moat = Math.min(20, Math.round(totalScore * 0.3));
                      scores.management = Math.min(20, Math.round(totalScore * 0.2));
                      scores.risk = ret1y > ret3y ? 20 : 10;
                      scores.explanation = "Based on Returns";
                } 
                else if (high52 > 0) {
                    const low52 = data.technicals?.low52 || (high52 * 0.7); 
                    const range = high52 - low52;
                    const position = ((price - low52) / range) * 100;
                    scores.total = Math.min(99, Math.round(20 + (position * 0.7))); 
                    scores.business = Math.round(scores.total * 0.4);
                    scores.moat = Math.round(scores.total * 0.2);
                    scores.management = Math.round(scores.total * 0.2);
                    scores.risk = Math.round(scores.total * 0.2);
                    scores.explanation = "Trend Strength";
                } else {
                      return null;
                }
            } 
            else {
                const roe = data.roe || 0;
                const roce = data.roce || 0; 
                const salesGrowth = data.growth || 0; 
                const profitGrowth = data.profitGrowth || 0;
                const opm = data.opm || 0; 
                const pe = data.pe || 0;
                const mcap = data.mcap || 0; 
                const beta = data.beta || 1.0;
                const ret1y = data.returns?.r1y || 0;
                const name = (data.name || '').toUpperCase();

                // TATA MOTORS FIX: Tighten financial detection to exclude manufacturing giants
                const isAutoOrPower = name.includes("MOTORS") || name.includes("AUTO") || name.includes("POWER") || name.includes("ENERGY") || name.includes("STEEL");
                const isFinancial = !isAutoOrPower && ((roce < 12 && roe > 15) || (name.includes("FINANCE") || name.includes("BANK") || name.includes("CAPITAL") || name.includes("HOLDINGS")));
                
                // Sales Growth
                if (salesGrowth > 15) scores.business += 15; 
                else if (salesGrowth > 8) scores.business += 10; 
                else if (salesGrowth > 0) scores.business += 5;
                else if (salesGrowth > -10) { scores.business += 2; reasons.push("Sales Drag"); }

                // Profit Growth
                if (profitGrowth > 15) scores.business += 15; 
                else if (profitGrowth > 8) scores.business += 10; 
                else if (profitGrowth > 0) scores.business += 5;
                else if (profitGrowth > -20) { scores.business += 2; reasons.push("Profit Drag"); }

                if (isFinancial) { 
                    if (roe > 15) scores.business += 10; else if (roe > 10) scores.business += 5; else if (roe > 5) scores.business += 2;
                } else { 
                    if (opm > 20) scores.business += 10; 
                    else if (opm > 12) scores.business += 5;
                    else if (opm > 8) { scores.business += 2; reasons.push("Low Margin"); }
                }
                scores.business = Math.min(40, scores.business);

                if (isFinancial) { if (roe > 18) scores.moat += 8; else if (roe > 12) scores.moat += 5; }
                else { if (opm > 18) scores.moat += 5; if (roce > 20) scores.moat += 5; }
                if (mcap > 20000) scores.moat += 5; else if (mcap > 5000) scores.moat += 3;
                if (profitGrowth > salesGrowth) scores.moat += 5; 
                if (ret1y > 40) scores.moat = Math.max(scores.moat + 5, 18);
                scores.moat = Math.min(20, scores.moat);

                if (pe > 0) {
                    if (pe < 15 && (profitGrowth > 10 || roe > 15)) scores.management += 20; 
                    else if (pe < 25) scores.management += 10;
                    else if (pe < 60) scores.management += 5;
                } else {
                    if (mcap > 50000) { scores.management += 10; reasons.push("Turnaround Giant"); }
                    else if (mcap > 10000) { scores.management += 5; reasons.push("Recovering"); }
                }
                scores.management = Math.min(20, scores.management);

                // MINIMUM CAPS LOGIC
                if (mcap > 0) {
                    if (mcap < 500) { scores.risk -= 10; reasons.push("Micro Cap Risk"); } 
                    else if (mcap > 5000) scores.risk += 10; 
                    else if (mcap > 2000) scores.risk += 5;
                }
                if (ret1y > 40) scores.risk += 10; else { if (beta < 1.1) scores.risk += 10; else if (beta < 1.3) scores.risk += 5; }
                scores.risk = Math.max(0, Math.min(20, scores.risk));

                scores.total = scores.business + scores.moat + scores.management + scores.risk;

                if (pe < 15 && roe > 15 && profitGrowth > 0) { scores.total += 15; reasons.push("High Quality Value"); }
                else if (pe < 12 && profitGrowth > 10) { scores.total += 10; reasons.push("Deep Value"); }

                scores.total = Math.min(99, scores.total); 
                if (reasons.length > 0) scores.explanation = reasons.slice(0, 2).join(" & ");
                else scores.explanation = scores.total > 50 ? "Stable" : "Weak";
            }
            return scores;
        }

        // --- SCORING ENGINE 2: PORTER'S 5 FORCES ---
        function calculatePortersScore(data) {
            if (data.type !== 'STOCK') return null;

            const roe = data.roe || 0;
            const roce = data.roce || 0;
            const salesGrowth = data.growth || 0;
            const profitGrowth = data.profitGrowth || 0;
            const opm = data.opm || 0;
            const mcap = data.mcap || 0;

            let pScore = { entrants: 0, suppliers: 0, buyers: 0, substitutes: 0, rivalry: 0, total: 0 };

            if (mcap > 10000 && roce > 20) pScore.entrants = 20;
            else if (mcap > 5000 && roce > 15) pScore.entrants = 15;
            else if (mcap > 2000) pScore.entrants = 10;
            else pScore.entrants = 5;

            if (opm > 25) pScore.suppliers = 20;
            else if (opm > 18) pScore.suppliers = 15;
            else if (opm > 10) pScore.suppliers = 10;
            else pScore.suppliers = 5;

            if (roe > 22) pScore.buyers = 20;
            else if (roe > 16) pScore.buyers = 15;
            else if (roe > 12) pScore.buyers = 10;
            else pScore.buyers = 5;

            if (salesGrowth > 15) pScore.substitutes = 20;
            else if (salesGrowth > 10) pScore.substitutes = 15;
            else if (salesGrowth > 5) pScore.substitutes = 10;
            else pScore.substitutes = 5;

            if (profitGrowth > 15) pScore.rivalry = 20;
            else if (profitGrowth > 10) pScore.rivalry = 15;
            else if (profitGrowth > 0) pScore.rivalry = 10;
            else pScore.rivalry = 5;

            pScore.total = Math.min(99, pScore.entrants + pScore.suppliers + pScore.buyers + pScore.substitutes + pScore.rivalry);
            return pScore;
        }

        // --- INDUSTRY-NORMALIZATION LOGIC ---
        function detectIndustry(data) {
            if (data.type !== 'STOCK') return 'GENERAL';
            const name = (data.name || '').toUpperCase();
            for (const [industry, profile] of Object.entries(INDUSTRY_PROFILES)) {
                if (profile.keywords.some(kw => name.includes(kw))) return industry;
            }
            return 'GENERAL';
        }

        function normalizeFundamentalScore(fScore, data) {
            if (!fScore) return null;
            const industry = detectIndustry(data);
            const profile = INDUSTRY_PROFILES[industry] || INDUSTRY_PROFILES['GENERAL'];

            for (let metric of profile.required || []) {
                if (data[metric] === null || data[metric] === undefined || data[metric] === 0) {
                     fScore.total = 0;
                     fScore.explanation = "Data Insufficient (Ind)";
                     return fScore;
                }
            }

            const components = ['business', 'moat', 'management', 'risk'];
            
            components.forEach(comp => {
                let w = profile.weights[comp] || 1.0;
                fScore[comp] = Math.round(fScore[comp] * w);
            });

            fScore.total = fScore.business + fScore.moat + fScore.management + fScore.risk;
            
            fScore.total = Math.min(99, fScore.total);
            if (industry !== 'GENERAL') {
               const suffix = `(${industry})`;
               if (!fScore.explanation.includes(suffix)) {
                   fScore.explanation = fScore.explanation ? `${fScore.explanation} ${suffix}` : suffix;
               }
            }
            
            return fScore;
        }

        // --- PORTFOLIO AGGREGATION & RISK LAYER --- 
        function calculatePortfolioAggregates() {
            let totalVal = 0;
            let weightedScoreSum = 0;
            let scoredVal = 0;
            let distribution = { 'Equity': 0, 'Cash': 0, 'Mutual Funds': 0, 'ETF': 0 };
            
            let industryExposure = {};
            let assetExposure = {};
            let topAssets = [];
            
            let weightedBetaSum = 0;
            let betaEquityVal = 0;
            
            portfolioAnalytics = { healthScore: 0, scoredValue: 0, totalValue: 0, allocation: {}, risk: { alerts: [], sectors: {}, divScore: 100, sensitivity: 'Moderate' }, efficiency: [] };

            Object.keys(portfolio).forEach(sym => {
                const qty = portfolio[sym].qty || 0;
                if (qty <= 0) return;

                const price = livePrices[sym] || 0;
                const val = qty * price;
                totalVal += val;
                
                assetExposure[sym] = val;
                
                let currentScore = 0;

                const data = stockAnalysis[sym];
                if (data) {
                    let type = 'Equity';
                    if (data.type === 'ETF') type = 'ETF';
                    else if (data.type === 'FUND') type = 'Mutual Funds';
                    distribution[type] = (distribution[type] || 0) + val;
                    
                    let ind = 'DIVERSIFIED';
                    if (type === 'Equity') {
                        ind = detectIndustry(data);
                        if (data.beta) {
                            weightedBetaSum += data.beta * val;
                            betaEquityVal += val;
                        }
                    } else {
                        if(data.name.includes("BANK")) ind = 'BANKING';
                        else if(data.name.includes("IT")) ind = 'IT';
                        weightedBetaSum += 1.0 * val;
                        betaEquityVal += val;
                    }
                    industryExposure[ind] = (industryExposure[ind] || 0) + val;

                    let fScore = calculateFundamentalScore(data);
                    if (fScore) {
                        fScore = normalizeFundamentalScore(fScore, data);
                        if (fScore.total > 0) {
                            currentScore = fScore.total;
                            weightedScoreSum += fScore.total * val;
                            scoredVal += val;
                        }
                    }
                } else {
                    distribution['Equity'] = (distribution['Equity'] || 0) + val; 
                    industryExposure['GENERAL'] = (industryExposure['GENERAL'] || 0) + val;
                }
                
                topAssets.push({ sym, val, score: currentScore });
            });
            
            portfolioAnalytics.totalValue = totalVal;
            portfolioAnalytics.scoredValue = scoredVal;
            portfolioAnalytics.allocation = distribution;
            if (scoredVal > 0) {
                portfolioAnalytics.healthScore = Math.round(weightedScoreSum / scoredVal);
            }
            
            if (betaEquityVal > 0) {
                const portfolioBeta = weightedBetaSum / betaEquityVal;
                if (portfolioBeta < 0.8) portfolioAnalytics.risk.sensitivity = 'Defensive';
                else if (portfolioBeta > 1.2) portfolioAnalytics.risk.sensitivity = 'Aggressive';
                else portfolioAnalytics.risk.sensitivity = 'Balanced';
            }

            if (totalVal > 0) {
                const MAX_SECTOR = 0.35; 
                const MAX_ASSET = 0.20; 
                let divPenalty = 0;

                const sortedInds = Object.entries(industryExposure).sort((a,b) => b[1] - a[1]);
                portfolioAnalytics.risk.sectors = sortedInds.slice(0, 3); 

                sortedInds.forEach(([ind, val]) => {
                    const pct = val / totalVal;
                    if (pct > MAX_SECTOR && ind !== 'DIVERSIFIED' && ind !== 'GENERAL') {
                        portfolioAnalytics.risk.alerts.push(`High Exposure to ${ind} (${Math.round(pct*100)}%)`);
                        divPenalty += (pct - MAX_SECTOR) * 100;
                    }
                });

                topAssets.sort((a,b) => b.val - a.val);
                topAssets.forEach(item => {
                    const pct = item.val / totalVal;
                    const pct100 = pct * 100;
                    const name = getDisplayName(item.sym); 
                    
                    if (pct > MAX_ASSET) {
                        portfolioAnalytics.risk.alerts.push(`Dominant Asset: ${name} (${Math.round(pct100)}%)`);
                        divPenalty += (pct - MAX_ASSET) * 100;
                    }
                    
                    if (item.score > 0) { 
                        if (item.score < 50 && pct100 > 10) {
                            portfolioAnalytics.efficiency.push({ type: 'bad', text: `High Allocation in Weak Asset: ${name}` });
                        } else if (item.score > 70 && pct100 < 3) {
                            portfolioAnalytics.efficiency.push({ type: 'good', text: `Under-allocated Winner: ${name}` });
                        } else if (item.score < 55 && pct100 < 2) {
                            portfolioAnalytics.efficiency.push({ type: 'tail', text: `Low Conviction Tail: ${name}` });
                        }
                    }
                });

                if (topAssets.length > 0) {
                    const top3Val = topAssets.slice(0, 3).reduce((acc, curr) => acc + curr.val, 0);
                    const top3Pct = top3Val / totalVal;
                    if (top3Pct > 0.60) {
                        portfolioAnalytics.risk.alerts.push(`Top 3 Assets constitute ${Math.round(top3Pct*100)}% of Portfolio`);
                        divPenalty += 10;
                    }
                }

                portfolioAnalytics.risk.divScore = Math.max(0, Math.round(100 - divPenalty));
            }
        }

        // --- AUTO SAVE LOGIC ---
        function saveState(pushToCloud = true) {
            const state = { portfolio: portfolio, analysis: stockAnalysis, activeTab: activeTab, cardViews: cardViews };
            localStorage.setItem('stockSightData', JSON.stringify(state));
            calculateTotals();
            updateViewCounts();
            if (activeTab === 'summary') renderSignalSummary();

            if (!pushToCloud) return;

            updateCloudStatus('loading', 'Saving...');
            if (saveTimeout) clearTimeout(saveTimeout);
            
            saveTimeout = setTimeout(async () => {
                if (isOfflineMode) { updateCloudStatus('error', 'Offline'); return; }
                try {
                    const cleanPayload = sanitizePortfolio(portfolio);
                    const res = await fetch(SHEET_API_URL, {
                        method: 'POST',
                        body: JSON.stringify(cleanPayload),
                        credentials: 'omit',
                        headers: { "Content-Type": "text/plain" } 
                    });
                    const json = await res.json();
                    if (json.status === 'success') {
                        updateCloudStatus('success', 'Saved');
                    } else {
                        throw new Error(json.message || "Script returned error");
                    }
                } catch (e) {
                    try {
                        const cleanPayload = sanitizePortfolio(portfolio);
                        await fetch(SHEET_API_URL, {
                            method: 'POST',
                            body: JSON.stringify(cleanPayload),
                            mode: 'no-cors',
                            credentials: 'omit',
                            headers: { "Content-Type": "text/plain" }
                        });
                        updateCloudStatus('success', 'Saved (Blind)');
                    } catch (err2) {
                        updateCloudStatus('error', 'Save Failed');
                    }
                }
            }, 2000); 
        }

        // --- INIT ---
        async function initApp() {
            const robustData = localStorage.getItem('stockSightData');
            if (robustData) {
                const state = JSON.parse(robustData);
                portfolio = sanitizePortfolio(state.portfolio) || {};
                stockAnalysis = state.analysis || {};
                activeTab = state.activeTab || 'portfolio';
                cardViews = state.cardViews || {};
                
                let migrationNeeded = false;
                Object.keys(portfolio).forEach(key => {
                    const clean = cleanTicker(key);
                    if (clean !== key) {
                        migrationNeeded = true;
                        portfolio[clean] = portfolio[key];
                        delete portfolio[key];
                        if (stockAnalysis[key]) { stockAnalysis[clean] = stockAnalysis[key]; delete stockAnalysis[key]; }
                        if (cardViews[key]) { cardViews[clean] = cardViews[key]; delete cardViews[key]; }
                    }
                });
                
                if (migrationNeeded) saveState(false);

                Object.keys(stockAnalysis).forEach(sym => {
                    if(stockAnalysis[sym].price) livePrices[sym] = stockAnalysis[sym].price;
                });
                renderUI();
            } else if (localStorage.getItem('stockPortfolio')) {
                portfolio = sanitizePortfolio(JSON.parse(localStorage.getItem('stockPortfolio')));
                renderUI();
            } else {
                document.getElementById('empty-watchlist').innerHTML = "Initializing...";
            }

            await performCloudSync();

            const symbols = Object.keys(portfolio);
            if (symbols.length > 0) {
                setTimeout(() => { symbols.forEach(sym => fetchAsset(sym)); }, 100);
            }
        }

        async function performCloudSync() {
            updateCloudStatus('loading', 'Syncing...');
            isOfflineMode = false;
            try {
                const response = await fetch(SHEET_API_URL, { method: 'GET', credentials: 'omit' });
                if (!response.ok) throw new Error("HTTP " + response.status);
                const cloudData = await response.json();
                if (cloudData.status === 'error') throw new Error(cloudData.message);

                if (cloudData && Object.keys(cloudData).length > 0) {
                    portfolio = sanitizePortfolio(cloudData);
                    saveState(false); 
                    renderUI(); 
                } else if (Object.keys(portfolio).length > 0) {
                    saveState(true);
                }
                updateCloudStatus('success', 'Synced');
            } catch (e) {
                isOfflineMode = true;
                updateCloudStatus('error', 'Offline');
                document.getElementById('main-empty-state').classList.add('hidden');
                if (Object.keys(portfolio).length === 0) document.getElementById('empty-watchlist').innerHTML = "Offline Mode.<br>Add stocks locally.";
            }
        }

        function forceSync() { sessionStorage.removeItem('syncErrorShown'); performCloudSync(); }

        function renderUI() {
            const symbols = Object.keys(portfolio).filter(key => {
                const k = key.toLowerCase();
                return !BLACKLIST_KEYS.some(bad => k.includes(bad));
            });

            if (symbols.length > 0) {
                document.getElementById('empty-watchlist').classList.add('hidden');
                document.getElementById('main-empty-state').classList.add('hidden');
                symbols.forEach(sym => {
                    if (stockAnalysis[sym]) renderCard(sym, stockAnalysis[sym], true); 
                    else createCardSkeleton(sym);
                    renderWatchlistItem(sym, !stockAnalysis[sym]);
                });
            }
            switchTab(activeTab);
            updateViewCounts();
            calculateTotals();
        }

        // --- FETCHING ---
        const PROXIES = [
            { url: (url) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`, type: 'text' },
            { url: (url) => `https://api.allorigins.win/get?url=${encodeURIComponent(url)}&t=${Date.now()}`, type: 'json' },
            { url: (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`, type: 'text' },
            { url: (url) => `https://thingproxy.freeboard.io/fetch/${encodeURIComponent(url)}`, type: 'text' }
        ];

        async function fetchWithFallback(targetUrl) {
            let lastError;
            for (const proxy of PROXIES) {
                try {
                    const controller = new AbortController();
                    const id = setTimeout(() => controller.abort(), 10000); 
                    const res = await fetch(proxy.url(targetUrl), { signal: controller.signal });
                    clearTimeout(id);
                    if(!res.ok) throw new Error(`HTTP ${res.status}`);
                    let content = proxy.type === 'json' ? (await res.json()).contents : await res.text();
                    if(!content || content.length < 50) throw new Error("Empty/Blocked");
                    if(targetUrl.includes('yahoo') && !content.trim().startsWith('{') && !content.includes('QuoteSummaryStore')) throw new Error("Invalid Yahoo");
                    return content;
                } catch(e) { lastError = e; }
            }
            throw lastError;
        }

        // --- ASSET ROUTER ---
        const ETF_KEYWORDS = ['BEES', 'ETF', 'GOLD', 'LIQUID', 'HANGSENG', 'NIFTY', 'SENSEX', 'MOVALUE', 'MOMENTUM', 'MIDCAP', 'SMALLCAP', 'JUNIOR'];

        async function fetchAsset(input) {
            const lowerInput = input.toLowerCase();
            if(BLACKLIST_KEYS.some(k => lowerInput.includes(k))) return;

            activeRequests++;
            updateReqCount();
            const sym = input.toUpperCase();
            try {
                if (/^\d{5,6}$/.test(sym)) await fetchMutualFund(sym);
                else await fetchStockOrETF(sym);
                const card = document.getElementById(`card-${sym}`);
                if(card) card.classList.remove('updating');
            } catch(e) {
                renderErrorCard(sym, e.message);
            } finally {
                activeRequests--;
                updateReqCount();
            }
        }

        async function fetchMutualFund(code) {
            const url = `https://api.mfapi.in/mf/${code}`;
            const res = await fetch(url);
            if(!res.ok) throw new Error("MF Not Found");
            const json = await res.json();
            const data = { 
                name: json.meta.scheme_name, 
                price: parseFloat(json.data[0].nav), 
                type: 'FUND', 
                meta: json.meta.fund_house,
                returns: calculateMFReturns(json.data) 
            };
            livePrices[code] = data.price;
            renderCard(code, data);
        }

        async function fetchStockOrETF(sym, betaPromise) {
            const isLikelyETF = ETF_KEYWORDS.some(k => sym.includes(k));
            if (!isLikelyETF) {
                try {
                    const html = await fetchWithFallback(`https://www.screener.in/company/${sym}/consolidated/`);
                    const parser = new DOMParser();
                    const doc = parser.parseFromString(html, 'text/html');
                    const ratios = doc.getElementById('top-ratios');
                    if (ratios) {
                        const getVal = (txt) => {
                            for(let li of ratios.querySelectorAll('li')) {
                                if(li.innerText.toLowerCase().includes(txt.toLowerCase())) return parseFloat(li.querySelector('.number')?.innerText.replace(/,/g,'') || 0);
                            }
                            return null;
                        };
                        const price = getVal('Current Price');
                        if(price) {
                            let growth = 0;
                            let opm = getVal('OPM %') || 0; 
                            let profitGrowth = 0;
                            const idxSales = html.indexOf("Compounded Sales Growth");
                            if(idxSales > -1) {
                                const sub = html.substring(idxSales, idxSales+1500);
                                let m = sub.match(/3 Years:[\s\S]*?([0-9\.-]+)\s?%/i);
                                growth = m ? parseFloat(m[1]) : 0;
                            }
                            const idxProfit = html.indexOf("Compounded Profit Growth");
                            if(idxProfit > -1) {
                                const sub = html.substring(idxProfit, idxProfit+1500);
                                let m = sub.match(/3 Years:[\s\S]*?([0-9\.-]+)\s?%/i);
                                profitGrowth = m ? parseFloat(m[1]) : 0;
                            }
                            let extraData = {};
                            try {
                                const yData = await fetchYahooQuote(`${sym}.NS`);
                                if(yData) extraData = { beta: yData.beta, returns: yData.returns };
                            } catch(e) {}
                            const data = { 
                                name: doc.querySelector('h1')?.innerText || sym, 
                                price: price, 
                                pe: getVal('Stock P/E'), 
                                roe: getVal('ROE'),
                                roce: getVal('ROCE'), 
                                mcap: getVal('Market Cap'),
                                opm: opm,
                                growth: growth,
                                profitGrowth: profitGrowth,
                                beta: extraData.beta || 1.0,
                                returns: extraData.returns, 
                                type: 'STOCK' 
                            };
                            livePrices[sym] = data.price;
                            renderCard(sym, data);
                            return; 
                        }
                    }
                } catch (e) {}
            }
            try {
                let targetSym = sym.endsWith('.NS') || sym.endsWith('.BO') ? sym : `${sym}.NS`;
                let data = await fetchYahooQuote(targetSym);
                if (!data && !sym.includes('.')) data = await fetchYahooQuote(`${sym}.BO`);
                if (data) {
                    livePrices[sym] = data.price;
                    renderCard(sym, data);
                    return;
                }
            } catch (yErr) {}
            try {
                const gData = await fetchGoogleFinance(sym);
                if (gData) {
                    livePrices[sym] = gData.price;
                    renderCard(sym, gData);
                    return;
                }
            } catch (gErr) {}
            throw new Error("Asset not found");
        }

        async function fetchYahooQuote(yahooSym) {
            try {
                const chartUrl = `https://query1.finance.yahoo.com/v8/finance/chart/${yahooSym}?interval=1mo&range=5y`;
                const chartJsonStr = await fetchWithFallback(chartUrl);
                const chartJson = JSON.parse(chartJsonStr);
                const result = chartJson?.chart?.result?.[0];
                const meta = result?.meta;
                
                if (meta && meta.regularMarketPrice) {
                    const quotes = result.indicators.quote[0].close;
                    const calcRet = (months) => {
                        if(!quotes || quotes.length < months) return 0;
                        const curr = quotes[quotes.length-1];
                        const old = quotes[quotes.length - 1 - months];
                        if(!old) return 0;
                        const years = months/12;
                        return ((Math.pow(curr/old, 1/years) - 1) * 100);
                    };
                    const rawName = meta.symbol || yahooSym;
                    const cleanName = rawName.replace('.NS', '').replace('.BO', '');
                    return { 
                        name: cleanName, 
                        price: meta.regularMarketPrice, 
                        type: 'ETF', 
                        pe: null, 
                        beta: 1.0, 
                        roe: null,
                        returns: { r1y: calcRet(12), r3y: calcRet(36), r5y: calcRet(60) },
                        technicals: { 
                            high52: meta.fiftyTwoWeekHigh,
                            ma50: meta.fiftyDayAverage,
                            ma200: meta.twoHundredDayAverage
                        }
                    };
                }
            } catch(e) {
                const url = `https://query1.finance.yahoo.com/v7/finance/quote?symbols=${yahooSym}`;
                const jsonStr = await fetchWithFallback(url);
                const json = JSON.parse(jsonStr);
                const res = json?.quoteResponse?.result?.[0];
                if(res) {
                    return {
                        name: res.shortName || yahooSym,
                        price: res.regularMarketPrice,
                        type: res.trailingPE ? 'STOCK' : 'ETF',
                        pe: res.trailingPE,
                        beta: res.beta || 1.0,
                        returns: { r1y: 0, r3y: 0, r5y: 0 } 
                    };
                }
            }
            return null;
        }

        async function fetchGoogleFinance(sym) {
            let html = await fetchWithFallback(`https://www.google.com/finance/quote/${sym}:NSE`);
            if (html.includes("Couldn't find")) html = await fetchWithFallback(`https://www.google.com/finance/quote/${sym}:BSE`);
            
            const priceMatch = html.match(/class="YMlKec fxKbKc">₹?([0-9,.]+)</);
            const nameMatch = html.match(/<div class="zzDege">([^<]+)</);
            const rangeMatch = html.match(/Year range.*?<div[^>]*>₹?([0-9,.]+)\s*-\s*₹?([0-9,.]+)/);

            if (priceMatch) {
                const price = parseFloat(priceMatch[1].replace(/,/g, ''));
                let high52 = 0, low52 = 0;
                if(rangeMatch) {
                    low52 = parseFloat(rangeMatch[1].replace(/,/g, ''));
                    high52 = parseFloat(rangeMatch[2].replace(/,/g, ''));
                } else {
                    high52 = price * 1.05; low52 = price * 0.95; 
                }
                return { 
                    name: nameMatch ? nameMatch[1] : sym, 
                    price: price, 
                    type: 'ETF', 
                    pe: null, roe: null, 
                    source: 'Google', 
                    technicals: { high52, low52 }
                };
            }
            return null;
        }

        // --- RENDERING ---
        function renderCard(sym, data, isCached = false) {
            const qty = portfolio[sym].qty || 0;
            const isHeld = qty > 0;
            const targetContainerId = isHeld ? 'view-portfolio' : 'view-watchlist';
            const container = document.getElementById(targetContainerId);
            
            let card = document.getElementById(`card-${sym}`);
            if (!card) {
                card = document.createElement('div');
                card.id = `card-${sym}`;
                container.appendChild(card);
            } else if (card.parentElement.id !== targetContainerId) {
                container.appendChild(card);
            }

            let signal = "HOLD", sigClass = "signal-hold", typeBadge = "badge-stock", metricsHTML = "";
            let sourceTag = data.source === 'Google' ? `<span class="badge-gfin text-[9px] px-1 rounded ml-1">G-FIN</span>` : "";
            const cleanSym = cleanTicker(sym);

            // Calculate Scores
            // INDUSTRY-NORMALIZATION: Step 1 - Get Base Score
            let fScore = calculateFundamentalScore(data);
            
            // INDUSTRY-NORMALIZATION: Step 2 - Apply Normalization Layer
            if (fScore) {
                fScore = normalizeFundamentalScore(fScore, data);
            }

            const pScore = calculatePortersScore(data);
            const tScore = calculateTrajectoryScore(data);
            const rsScore = calculateRelativeStrength(data);
            
            // Boost & Normalize Logic
            if (fScore) {
                let rawTotal = fScore.total + tScore + rsScore;
                
                if (data.type === 'ETF' || data.type === 'FUND') {
                      // Apply Normalization Engine ONLY for ETFs/Funds (Logarithmic curve)
                      fScore.total = calculateNormalizedScore(rawTotal);
                } else {
                      // Stocks: Simple cap at 99 (Linear)
                      fScore.total = Math.max(0, Math.min(99, rawTotal));
                }
            }

            const viewMode = cardViews[sym] || 'fundamental';
            let longTermLabel = "";
            
            const conviction = calculateConviction(fScore, pScore);
            const convictionBadge = getConvictionBadge(conviction);
            const trajectory = calculateTrajectory(data);
            const trajectoryBadge = getTrajectoryBadge(trajectory);
            const timing = calculateTiming(data);
            const timingBadge = getTimingBadge(timing);
            const fundTiming = calculateFundamentalTiming(data);
            const fundTimingBadge = getFundamentalTimingBadge(fundTiming);

            // NEW EXTENSION: Confidence Gate
            const confidence = calculateDataConfidence(data);

            const decision = calculateFinalDecision(conviction, trajectory, timing, data.type, isHeld);
            if (fScore) {
                decision.summary = calculateScoreActionMapper(fScore.total, fundTiming, conviction, isHeld);
            }
            
            // Pass confidence to decision block
            const decisionBlock = getDecisionBlock(decision, confidence);
            const moreshwarBlock = getMoreshwarBlock(data.price, fScore, pScore, isHeld, decision.action);

            const rsColor = rsScore > 0 ? 'text-green-600' : (rsScore < 0 ? 'text-red-600' : 'text-gray-400');
            const rsSign = rsScore > 0 ? '+' : '';

            if(data.type === 'STOCK' && fScore) {
                typeBadge = "badge-stock";
                
                if (fScore.total >= 65) { signal = "BUY"; sigClass = "signal-buy"; }
                else if (fScore.total <= 40) { signal = "SELL"; sigClass = "signal-sell"; }

                if (pScore && pScore.total > fScore.total) {
                    longTermLabel = `<div class="text-[8px] font-semibold bg-purple-100 text-purple-700 px-1.5 py-0.5 rounded border border-purple-200 mt-1 text-right">Long Term Potential</div>`;
                }

                if (!isHeld) {
                    if (signal === "HOLD") signal = "WAIT";
                    if (signal === "SELL") { signal = "AVOID"; sigClass = "signal-gray"; }
                }

                const tabHTML = `
                    <div class="flex gap-2 mb-3 mt-1">
                        <button onclick="switchCardTab('${sym}', 'fundamental')" class="analysis-tab ${viewMode === 'fundamental' ? 'active-fund' : 'inactive'}">Fundamental</button>
                        <button onclick="switchCardTab('${sym}', 'porter')" class="analysis-tab ${viewMode === 'porter' ? 'active-port' : 'inactive'}">Porter's 5</button>
                    </div>
                `;

                if (viewMode === 'fundamental') {
                    metricsHTML = `
                        ${tabHTML}
                        <div class="space-y-3 animate-fade-in">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-xs font-bold w-8 text-right">${fScore.total}</span>
                                <div class="flex-1 score-bar-bg h-2">
                                    <div class="score-bar-fill ${fScore.total > 60 ? 'bg-green-500' : (fScore.total < 40 ? 'bg-red-500' : 'bg-yellow-500')}" style="width: ${fScore.total}%"></div>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-[10px]">
                                <div class="bg-gray-50 p-1.5 rounded"><span class="text-gray-400 block">Business</span><span class="font-bold text-gray-700">${fScore.business}/40</span></div>
                                <div class="bg-gray-50 p-1.5 rounded"><span class="text-gray-400 block">Moat</span><span class="font-bold text-gray-700">${fScore.moat}/20</span></div>
                                <div class="bg-gray-50 p-1.5 rounded"><span class="text-gray-400 block">Mgmt</span><span class="font-bold text-gray-700">${fScore.management}/20</span></div>
                                <div class="bg-gray-50 p-1.5 rounded"><span class="text-gray-400 block">Risk</span><span class="font-bold text-gray-700">${fScore.risk}/20</span></div>
                                <div class="bg-indigo-50 p-1.5 rounded"><span class="text-gray-400 block">Trajectory</span><span class="font-bold text-indigo-700">+${tScore}</span></div>
                                <div class="bg-gray-50 p-1.5 rounded"><span class="text-gray-400 block">Rel Strength</span><span class="font-bold ${rsColor}">${rsSign}${rsScore}</span></div>
                            </div>
                            ${decisionBlock}
                            ${moreshwarBlock}
                        </div>`;
                } else if (viewMode === 'porter') {
                    metricsHTML = `
                        ${tabHTML}
                        <div class="space-y-3 animate-fade-in">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="text-xs font-bold w-8 text-right text-blue-600">${pScore.total}</span>
                                <div class="flex-1 score-bar-bg h-2">
                                    <div class="score-bar-fill bg-blue-500" style="width: ${pScore.total}%"></div>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-2 text-[10px]">
                                <div class="bg-blue-50 p-1.5 rounded"><span class="text-gray-400 block">Barriers</span><span class="font-bold text-blue-800">${pScore.entrants}/20</span></div>
                                <div class="bg-blue-50 p-1.5 rounded"><span class="text-gray-400 block">Suppliers</span><span class="font-bold text-blue-800">${pScore.suppliers}/20</span></div>
                                <div class="bg-blue-50 p-1.5 rounded"><span class="text-gray-400 block">Buyers</span><span class="font-bold text-blue-800">${pScore.buyers}/20</span></div>
                                <div class="bg-blue-50 p-1.5 rounded"><span class="text-gray-400 block">Substitutes</span><span class="font-bold text-blue-800">${pScore.substitutes}/20</span></div>
                                <div class="col-span-2 bg-blue-50 p-1.5 rounded flex justify-between"><span class="text-gray-400">Competitive Rivalry</span><span class="font-bold text-blue-800">${pScore.rivalry}/20</span></div>
                            </div>
                            ${decisionBlock}
                            ${moreshwarBlock}
                        </div>`;
                }

            } else if (fScore) {
                // ... existing ETF logic ...
                signal = "SIP"; sigClass = "signal-sip";
                if (fScore.total > 70) signal = "BUY"; 
                
                if (qty === 0) {
                     if (signal === "SIP") { signal = "TRACK"; sigClass = "signal-gray"; }
                }

                typeBadge = data.type === 'ETF' ? "badge-etf" : "badge-fund";
                const isMF = data.type === 'FUND';
                
                let l1="Returns", l2="Momentum", l3="Trend", l4="Safety";
                if(data.explanation === "Trend Strength") { l1="Trend"; l2="Momentum"; l3="Strength"; l4="Support"; }
                else if(isMF) { l1="1Y Ret"; l2="3Y Ret"; l3="5Y Ret"; l4="Trend"; }

                metricsHTML = `
                    <div class="space-y-3">
                         <div class="flex items-center gap-2 mb-2">
                            <span class="text-xs font-bold w-8 text-right">${fScore.total}</span>
                            <div class="flex-1 score-bar-bg h-2">
                                <div class="score-bar-fill bg-blue-500" style="width: ${fScore.total}%"></div>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-[10px]">
                            <div class="bg-gray-50 p-1.5 rounded"><span class="text-gray-400 block">${l1}</span><span class="font-bold text-gray-700">${fScore.business}/40</span></div>
                            <div class="bg-gray-50 p-1.5 rounded"><span class="text-gray-400 block">${l2}</span><span class="font-bold text-gray-700">${fScore.moat}/20</span></div>
                            <div class="bg-gray-50 p-1.5 rounded"><span class="text-gray-400 block">${l3}</span><span class="font-bold text-gray-700">${fScore.management}/20</span></div>
                            <div class="bg-gray-50 p-1.5 rounded"><span class="text-gray-400 block">${l4}</span><span class="font-bold text-gray-700">${fScore.risk}/20</span></div>
                        </div>
                        ${decisionBlock}
                        ${moreshwarBlock}
                    </div>`;
            } else {
                 metricsHTML = ``; 
                 signal = "N/A"; sigClass = "signal-gray";
            }

            stockAnalysis[sym] = { 
                signal, name: data.name, price: data.price, type: data.type, 
                pe: data.pe, growth: data.growth, profitGrowth: data.profitGrowth, opm: data.opm,
                roe: data.roe, mcap: data.mcap, roce: data.roce, beta: data.beta, source: data.source,
                returns: data.returns, technicals: data.technicals,
                // PORTFOLIO-SUMMARY: Store calculated fields for summary rendering
                action: decision.action,
                explanation: fScore?.explanation,
                levels: calculateMoreshwarLevels(data.price, fScore, pScore, isHeld)
            };
            if(!isCached) saveState(true); 

            const savedQty = portfolio[sym].qty || '';
            const savedAvg = portfolio[sym].avg || '';
            const opacityClass = isCached ? 'updating' : '';

            // Add MC Link
            const mcBtn = `<a href="https://www.google.com/search?q=${encodeURIComponent(data.name + " moneycontrol news")}" target="_blank" class="text-[9px] bg-emerald-50 text-emerald-700 border border-emerald-200 px-1.5 rounded ml-1 hover:bg-emerald-100 transition-colors cursor-pointer" title="MoneyControl News" onclick="event.stopPropagation()">MC News</a>`;

            card.className = `bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden min-h-[340px] flex flex-col relative ${opacityClass}`;
            card.innerHTML = `
                <div class="p-5 flex flex-col h-full">
                    <div class="flex justify-between items-start mb-2">
                        <div class="overflow-hidden">
                            <h3 class="font-bold text-gray-800 text-lg leading-tight truncate w-40" title="${data.name}">${data.name}</h3>
                            <div class="flex gap-2 mt-1 items-center flex-wrap">
                                <span class="text-[10px] font-mono text-gray-500 bg-gray-100 px-1 rounded">${cleanSym}</span>
                                <span class="text-[10px] px-1 rounded font-bold ${typeBadge}">${data.type}</span>
                                ${convictionBadge}
                                ${fundTimingBadge}
                                ${trajectoryBadge}
                                ${timingBadge}
                                ${sourceTag}
                                ${mcBtn}
                            </div>
                        </div>
                        <div class="flex flex-col items-end">
                            <div class="text-[10px] font-bold px-2 py-1 rounded border ${sigClass}">${signal}</div>
                            <span class="text-[9px] text-gray-400 mt-1 italic w-20 text-right leading-tight">${fScore?.explanation || ''}</span>
                            ${longTermLabel}
                        </div>
                    </div>

                    <div class="flex justify-between items-end pb-3 border-b border-gray-100 mb-3">
                        <p class="text-2xl font-bold text-gray-800">₹${data.price.toLocaleString()}</p>
                    </div>

                    <div class="bg-gray-50 rounded border border-gray-100 p-2 mb-3">
                        <div class="flex gap-2 mb-1">
                            <div class="flex-1"><label class="text-[9px] text-gray-500 uppercase block mb-1">Qty</label><input type="number" class="portfolio-input" placeholder="0" value="${savedQty}" onchange="updateHolding('${sym}', 'qty', this.value)"></div>
                            <div class="flex-1"><label class="text-[9px] text-gray-500 uppercase block mb-1">Avg</label><input type="number" class="portfolio-input" placeholder="₹" value="${savedAvg}" onchange="updateHolding('${sym}', 'avg', this.value)"></div>
                        </div>
                        <div class="flex justify-between items-center text-xs pt-1"><span class="text-gray-400">P&L:</span><span id="pnl-${sym}" class="font-bold text-gray-300">--</span></div>
                    </div>
                    
                    ${metricsHTML}
                </div>`;
            
            if(!isCached) {
                renderWatchlistItem(sym, false);
                updateCardPnL(sym);
                calculateTotals();
                updateViewCounts();
            } else {
                updateCardPnL(sym);
            }
        }

        // --- UI INTERACTION ---
        window.switchCardTab = function(sym, mode) {
            cardViews[sym] = mode;
            if (stockAnalysis[sym]) {
                renderCard(sym, stockAnalysis[sym], false); 
                saveState(false); 
            }
        }

        function createCardSkeleton(sym) {
            const qty = portfolio[sym].qty || 0;
            const containerId = qty > 0 ? 'view-portfolio' : 'view-watchlist';
            const grid = document.getElementById(containerId);
            const card = document.createElement('div');
            card.id = `card-${sym}`;
            card.className = "bg-white rounded-lg border border-gray-200 shadow-sm overflow-hidden min-h-[300px] relative";
            card.innerHTML = `<div class="absolute inset-0 flex flex-col items-center justify-center z-10 bg-white/80"><div class="loader mb-2"></div><p class="text-xs text-gray-400">Loading ${cleanTicker(sym)}...</p></div>`;
            grid.insertBefore(card, grid.firstChild);
        }

        function renderWatchlistItem(sym, isLoading) {
            const container = document.getElementById('watchlist-container');
            let item = document.getElementById(`wl-${sym}`);
            const price = livePrices[sym] ? `₹${livePrices[sym].toLocaleString()}` : '--';
            const qty = portfolio[sym].qty || 0;
            const icon = qty > 0 ? '💼' : '👁️'; 
            
            const cleanSym = cleanTicker(sym);

            if (!item) {
                item = document.createElement('div');
                item.id = `wl-${sym}`;
                item.className = "watchlist-item p-3 border-b border-gray-100 hover:bg-gray-50 cursor-pointer flex justify-between items-center group transition-colors";
                item.onclick = () => { 
                    const targetTab = portfolio[sym].qty > 0 ? 'portfolio' : 'watchlist';
                    switchTab(targetTab);
                    setTimeout(() => document.getElementById(`card-${sym}`)?.scrollIntoView({behavior:'smooth'}), 50); 
                };
                container.insertBefore(item, container.firstChild);
            }
            item.innerHTML = isLoading ? 
                `<div><span class="text-sm font-semibold">${cleanSym}</span></div><div class="loader w-3 h-3 border-gray-300 border-t-maroon"></div>` : 
                `<div><span class="mr-2 text-xs opacity-50">${icon}</span><span class="text-sm font-semibold">${cleanSym}</span></div><div class="text-right"><span class="font-mono text-sm">${price}</span><button onclick="event.stopPropagation(); removeStock('${sym}')" class="delete-btn opacity-0 group-hover:opacity-100 text-[10px] text-red-500 uppercase ml-2">Del</button></div>`;
        }

        function renderErrorCard(sym, msg) {
            const qty = portfolio[sym].qty || 0;
            const containerId = qty > 0 ? 'view-portfolio' : 'view-watchlist';
            const container = document.getElementById(containerId);
            let card = document.getElementById(`card-${sym}`);
            if (!card) {
                card = document.createElement('div');
                card.id = `card-${sym}`;
                container.appendChild(card);
            }
            card.innerHTML = `<div class="flex flex-col items-center justify-center h-full p-6 text-center"><span class="text-red-400 font-bold mb-1">Failed</span><span class="text-xs text-gray-400 mb-4 break-words w-full px-4">${msg || "Proxy Error"}</span><button onclick="fetchAsset('${sym}')" class="px-3 py-1 bg-white border border-red-200 text-red-500 text-xs rounded hover:bg-red-50 mb-2">Retry</button><button onclick="removeStock('${sym}')" class="text-xs text-gray-400 underline">Remove</button></div>`;
            const item = document.getElementById(`wl-${sym}`);
            if(item) item.innerHTML = `<span class="text-sm font-semibold text-gray-400">${cleanTicker(sym)}</span><span class="text-xs text-red-500">Error</span>`;
        }

        // --- CORE FUNCTIONS ---
        function processInput() {
            const input = document.getElementById('stockInput');
            const val = input.value.trim().toUpperCase();
            if(!val) return;
            const symbols = val.split(',').map(s => s.trim()).filter(s => s);
            input.value = '';
            document.getElementById('empty-watchlist').classList.add('hidden');
            document.getElementById('main-empty-state').classList.add('hidden');
            symbols.forEach(rawSym => {
                const sym = cleanTicker(rawSym); 
                if(portfolio[sym]) return;
                portfolio[sym] = { qty: 0, avg: 0 };
                switchTab('watchlist'); 
                renderWatchlistItem(sym, true);
                createCardSkeleton(sym);
                fetchAsset(sym);
            });
            saveState(); 
        }

        function removeStock(sym) {
            delete portfolio[sym]; delete livePrices[sym]; delete stockAnalysis[sym];
            const w = document.getElementById(`wl-${sym}`);
            const c = document.getElementById(`card-${sym}`);
            if(w) w.remove(); if(c) c.remove();
            saveState();
        }

        function clearAll() {
            if(confirm("Clear All?")) {
                portfolio = {}; livePrices = {}; stockAnalysis = {};
                document.getElementById('watchlist-container').innerHTML = `<div id="empty-watchlist" class="p-8 text-center text-gray-400 text-sm italic">Add stocks...</div>`;
                document.getElementById('view-portfolio').innerHTML = '';
                document.getElementById('view-watchlist').innerHTML = '';
                document.getElementById('main-empty-state').classList.remove('hidden');
                saveState();
            }
        }

        function handleEnter(e) { if(e.key === "Enter") processInput(); }
        function updateReqCount() { document.getElementById('requestCounter').style.display = activeRequests > 0 ? 'block' : 'none'; }
        
        window.updateHolding = function(sym, field, val) { 
            if(!portfolio[sym]) return; 
            const oldQty = portfolio[sym].qty;
            portfolio[sym][field] = parseFloat(val) || 0; 
            
            if (field === 'qty') {
                const newQty = portfolio[sym].qty;
                if ((oldQty === 0 && newQty > 0) || (oldQty > 0 && newQty === 0)) {
                    if (stockAnalysis[sym]) renderCard(sym, stockAnalysis[sym]);
                    renderWatchlistItem(sym, false);
                }
            }
            saveState(); 
            updateCardPnL(sym); 
            calculateTotals(); 
        }

        function updateCardPnL(sym) { if(!portfolio[sym] || !livePrices[sym]) return; const qty = portfolio[sym].qty; const avg = portfolio[sym].avg; const cur = livePrices[sym]; const pnl = (qty * cur) - (qty * avg); const el = document.getElementById(`pnl-${sym}`); if(el) { el.innerText = `₹${Math.round(pnl).toLocaleString()}`; el.className = `font-bold text-xs ${pnl >= 0 ? 'text-green-600' : 'text-red-500'}`; } }
        function calculateTotals() { let tInv = 0, tCur = 0; for(let sym in portfolio) { if(livePrices[sym]) { const q = portfolio[sym].qty; tInv += q * portfolio[sym].avg; tCur += q * livePrices[sym]; } } const pnl = tCur - tInv; document.getElementById('total-value').innerText = `₹${Math.round(tCur).toLocaleString()}`; const pnlEl = document.getElementById('total-pnl'); pnlEl.innerText = `₹${Math.round(pnl).toLocaleString()}`; pnlEl.className = `font-bold text-lg leading-tight ${pnl >= 0 ? 'text-green-600' : 'text-red-500'}`; calculatePortfolioAggregates(); }
        
        function switchTab(tab) { 
            activeTab = tab; 
            saveState(false); 
            const views = { 'portfolio': 'view-portfolio', 'watchlist': 'view-watchlist', 'summary': 'view-summary', 'support': 'view-support' };
            const tabs = { 'portfolio': 'tab-portfolio', 'watchlist': 'tab-watchlist', 'summary': 'tab-summary' };
            const es = document.getElementById('main-empty-state');

            // Handle Empty State Visibility
            if(Object.keys(portfolio).length === 0 && tab !== 'support') {
                 // Hide all main views
                Object.values(views).forEach(id => {
                     const el = document.getElementById(id);
                     if(el) el.classList.add('hidden');
                });
                es.classList.remove('hidden');
                return;
            } else {
                es.classList.add('hidden');
            }

            // Hide/Show Views based on Tab
            Object.keys(views).forEach(key => {
                const el = document.getElementById(views[key]);
                if (el) {
                    if (key === tab) el.classList.remove('hidden');
                    else el.classList.add('hidden');
                }
            });

            // Update Tab Styling
            Object.keys(tabs).forEach(key => {
                const btn = document.getElementById(tabs[key]);
                if (key === tab) {
                    btn.className = "tab-active py-1 transition-colors flex items-center gap-2";
                } else {
                    btn.className = "tab-inactive py-1 transition-colors flex items-center gap-2";
                }
            });

            if(tab === 'summary') renderSignalSummary();
        }

        // // SUPPORT-DOCS: Toggle Logic
        function toggleSupportView() {
            const summaryView = document.getElementById('view-summary');
            const supportView = document.getElementById('view-support');
            
            if (summaryView.classList.contains('hidden')) {
                // Currently in Support, go back to Summary
                summaryView.classList.remove('hidden');
                supportView.classList.add('hidden');
            } else {
                // Currently in Summary, go to Support
                summaryView.classList.add('hidden');
                supportView.classList.remove('hidden');
            }
        }

        // PORTFOLIO-SUMMARY: Rendering Logic
        function renderSignalSummary() { 
            const healthEl = document.getElementById('analytics-health');
            const allocEl = document.getElementById('analytics-allocation');
            const perfEl = document.getElementById('analytics-performance');
            const actionsEl = document.getElementById('analytics-actions'); // New Card

            if(!portfolioAnalytics.totalValue) {
                healthEl.innerHTML = `<div class="text-center text-gray-400 text-xs">No Data</div>`;
                return;
            }

            // Health & Risk Column
            let healthColor = 'text-amber-600';
            let healthLabel = 'Neutral';
            if(portfolioAnalytics.healthScore > 65) { healthColor = 'text-green-600'; healthLabel = 'Strong'; }
            else if(portfolioAnalytics.healthScore < 40) { healthColor = 'text-red-600'; healthLabel = 'Weak'; }
            
            let riskHTML = '';
            if (portfolioAnalytics.risk.alerts && portfolioAnalytics.risk.alerts.length > 0) {
                riskHTML = `<div class="mt-3 w-full px-2 space-y-1 overflow-y-auto max-h-[80px] custom-scroll border-t border-amber-200/50 pt-2">
                    ${portfolioAnalytics.risk.alerts.map(a => `<div class="text-[9px] text-amber-700 flex items-start"><span class="mr-1">⚠️</span>${a}</div>`).join('')}
                </div>`;
            } else {
                riskHTML = `<div class="mt-3 text-[10px] text-green-600 flex items-center"><span class="mr-1">✅</span>Well Diversified</div>`;
            }

            const sensitivity = portfolioAnalytics.risk.sensitivity || 'Moderate';
            const sensColor = sensitivity === 'Aggressive' ? 'text-red-500' : (sensitivity === 'Defensive' ? 'text-blue-500' : 'text-gray-500');

            healthEl.innerHTML = `
                <div class="flex flex-col items-center justify-center h-full pt-4 pb-4">
                    <div class="flex gap-4 mb-2">
                        <div class="text-center">
                            <div class="text-2xl font-bold ${healthColor}">${portfolioAnalytics.healthScore}</div>
                            <span class="text-[9px] uppercase text-amber-900/60">Quality</span>
                        </div>
                        <div class="text-center">
                            <div class="text-2xl font-bold text-blue-600">${portfolioAnalytics.risk.divScore || 100}</div>
                            <span class="text-[9px] uppercase text-amber-900/60">Diversity</span>
                        </div>
                    </div>
                    <div class="text-[10px] font-semibold border px-2 py-0.5 rounded ${sensColor} border-amber-200 bg-white mb-2">${sensitivity} Profile</div>
                    ${riskHTML}
                </div>
            `;

            // Allocation
            let allocHTML = '<div class="w-full space-y-2 flex flex-col justify-center h-full px-2">';
            let total = portfolioAnalytics.totalValue;
            Object.entries(portfolioAnalytics.allocation).forEach(([key, val]) => {
                let pct = Math.round((val/total)*100);
                if(pct > 0) {
                    allocHTML += `
                        <div class="flex items-center text-xs">
                            <span class="w-24 text-indigo-900 font-medium">${key}</span>
                            <div class="flex-1 h-2 bg-indigo-50 rounded overflow-hidden mr-2 border border-indigo-100">
                                <div class="h-full bg-indigo-500" style="width: ${pct}%"></div>
                            </div>
                            <span class="font-bold text-indigo-700">${pct}%</span>
                        </div>
                    `;
                }
            });
            
            if (portfolioAnalytics.risk.sectors && portfolioAnalytics.risk.sectors.length > 0) {
                allocHTML += `<div class="mt-4 pt-3 border-t border-indigo-200/50"><p class="text-[9px] text-indigo-400 uppercase mb-2 font-bold tracking-wider">Top Exposures</p>`;
                portfolioAnalytics.risk.sectors.forEach(([ind, val]) => {
                    let sPct = Math.round((val/total)*100);
                    if (sPct > 5) {
                        allocHTML += `<div class="flex justify-between text-[10px] text-indigo-800 mb-1"><span>${ind}</span><span class="font-mono text-indigo-600 font-bold">${sPct}%</span></div>`;
                    }
                });
                allocHTML += `</div>`;
            }
            
            allocHTML += '</div>';
            allocEl.innerHTML = allocHTML;

            // Performance & Efficiency Column
            const totalPnL = parseFloat(document.getElementById('total-pnl').innerText.replace(/[^0-9.-]/g, ''));
            const pnlPct = total > 0 ? (totalPnL / (total - totalPnL)) * 100 : 0;
            const pnlColor = totalPnL >= 0 ? 'text-emerald-600' : 'text-rose-600';
            
            let effHTML = '';
            if (portfolioAnalytics.efficiency && portfolioAnalytics.efficiency.length > 0) {
                effHTML = `<div class="mt-auto w-full pt-3 border-t border-emerald-100/50"><p class="text-[9px] text-emerald-800/60 uppercase mb-1 text-center font-bold tracking-wider">Efficiency Check</p>`;
                portfolioAnalytics.efficiency.forEach(item => {
                    let color = 'text-emerald-800';
                    if (item.type === 'bad') color = 'text-rose-600';
                    if (item.type === 'good') color = 'text-emerald-600';
                    effHTML += `<div class="text-[9px] ${color} text-center mb-0.5 bg-white/50 rounded py-0.5 px-1 leading-tight" title="${item.text}">${item.text}</div>`;
                });
                effHTML += `</div>`;
            } else if (total > 0) {
                effHTML = `<div class="mt-auto w-full pt-3 border-t border-emerald-100/50 text-center"><span class="text-[9px] text-emerald-600 font-medium">Capital Allocation Efficient</span></div>`;
            }

            perfEl.innerHTML = `
                <div class="flex flex-col items-center h-full w-full py-4">
                    <div class="flex-1 flex flex-col items-center justify-center">
                        <div class="text-3xl font-bold ${pnlColor} mb-1">${totalPnL >= 0 ? '+' : ''}${pnlPct.toFixed(1)}%</div>
                        <span class="text-xs text-emerald-900/60 mb-3 uppercase tracking-wide font-medium">Total Return</span>
                        <div class="text-sm font-mono font-bold text-emerald-800 bg-emerald-50 px-3 py-1.5 rounded border border-emerald-100 shadow-sm">₹${totalPnL.toLocaleString()}</div>
                    </div>
                    ${effHTML}
                </div>
            `;

            // PORTFOLIO-SUMMARY: Actions Card Logic
            let actionsList = [];
            Object.values(stockAnalysis).forEach(data => {
               if (data.action === 'BUY NOW') {
                   // Truncate explanation to ~3 words
                   let reason = (data.explanation || "").split(' ').slice(0,3).join(' ');
                   let entry = data.levels?.entry || data.price;
                   actionsList.push({ type: 'buy', text: `Buy ${data.name}`, sub: `@ ₹${entry.toLocaleString()}`, reason: reason });
               } else if (data.action === 'EXIT') {
                   let reason = (data.explanation || "").split(' ').slice(0,3).join(' ');
                   actionsList.push({ type: 'sell', text: `Sell ${data.name}`, sub: `@ ₹${data.price.toLocaleString()}`, reason: reason });
               }
            });

            if (actionsList.length === 0) {
                actionsEl.innerHTML = `<div class="h-full flex flex-col items-center justify-center text-violet-300 text-xs italic"><p>No Immediate Actions</p></div>`;
            } else {
                let listHTML = `<div class="w-full space-y-2 overflow-y-auto custom-scroll pr-1">`;
                actionsList.forEach(act => {
                    const icon = act.type === 'buy' ? '🟢' : '🔴';
                    const colorClass = act.type === 'buy' ? 'text-green-700 bg-green-50 border-green-100' : 'text-red-700 bg-red-50 border-red-100';
                    listHTML += `
                        <div class="p-2 rounded border ${colorClass} text-xs">
                            <div class="flex justify-between font-bold mb-0.5">
                                <span>${icon} ${act.text}</span>
                                <span class="font-mono">${act.sub}</span>
                            </div>
                            <div class="text-[9px] opacity-80 pl-5 italic">${act.reason}</div>
                        </div>
                    `;
                });
                listHTML += `</div>`;
                actionsEl.innerHTML = listHTML;
            }
        }
        
        function updateViewCounts() {
            let portCount = 0;
            let watchCount = 0;
            Object.values(portfolio).forEach(p => {
                if (p.qty > 0) portCount++;
                else watchCount++;
            });
            document.getElementById('watchlist-count').innerText = `${Object.keys(portfolio).length} / 50`;
            document.getElementById('badge-port-count').innerText = portCount;
            document.getElementById('badge-watch-count').innerText = watchCount;
            
            document.getElementById('portfolio-empty').style.display = portCount === 0 ? 'flex' : 'none';
            document.getElementById('watchlist-empty').style.display = watchCount === 0 ? 'flex' : 'none';
        }

        // --- EXTENSIONS ---
        
        function calculateConviction(fScore, pScore) {
            if (pScore) {
                const avg = (fScore.total + pScore.total) / 2;
                if (avg >= 60) return "Strong";
                if (avg <= 40) return "Weak";
                return "Stable";
            }
            if (fScore.total >= 65) return "Strong";
            if (fScore.total <= 40) return "Weak";
            return "Stable";
        }

        function getConvictionBadge(label) {
            if (!label) return '';
            const styles = { 'Strong': 'bg-emerald-100 text-emerald-800 border-emerald-200', 'Stable': 'bg-amber-100 text-amber-800 border-amber-200', 'Weak': 'bg-rose-100 text-rose-800 border-rose-200' };
            return `<span class="text-[9px] font-bold px-1.5 py-0.5 rounded border ${styles[label]} uppercase tracking-wider mx-1">${label}</span>`;
        }

        function calculateTrajectory(data) {
            if (data.type !== 'STOCK') return null;
            const sales = data.growth || 0; const profit = data.profitGrowth || 0; const roe = data.roe || 0;
            if (sales < 0 || profit < 0) return "Deteriorating";
            if (profit < 5 && sales < 5) return "Deteriorating"; 
            if (profit > sales && sales > 5 && profit > 10) return "Improving";
            if (roe > 20 && profit > 10) return "Improving";
            return "Flat";
        }

        function getTrajectoryBadge(label) {
            if (!label) return '';
            const styles = { 'Improving': 'bg-indigo-100 text-indigo-800 border-indigo-200', 'Flat': 'bg-gray-100 text-gray-600 border-gray-200', 'Deteriorating': 'bg-orange-100 text-orange-800 border-orange-200' };
            return `<span class="text-[9px] font-bold px-1.5 py-0.5 rounded border ${styles[label]} uppercase tracking-wider mx-1">${label}</span>`;
        }

        function calculateTiming(data) {
            const price = data.price || 0; const r1y = data.returns?.r1y || 0; const r3y = data.returns?.r3y || 0; const ma200 = data.technicals?.ma200 || 0;
            let trend = 'Neutral';
            if (ma200 > 0) trend = price > ma200 ? 'Up' : 'Down';
            else { if (r1y > 10) trend = 'Up'; else if (r1y < -5) trend = 'Down'; }
            let momentum = 'Stable';
            if (r1y > r3y + 5) momentum = 'Improving'; else if (r1y < r3y - 5) momentum = 'Weakening';
            if (trend === 'Up' && momentum === 'Improving') return "Favourable";
            if (trend === 'Down' && momentum === 'Weakening') return "Unfavourable";
            if (trend === 'Up' && momentum === 'Weakening') return "Neutral";
            if (trend === 'Down' && momentum === 'Improving') return "Neutral";
            if (r1y > 0) return "Neutral";
            return "Unfavourable";
        }

        function getTimingBadge(label) {
            if (!label) return '';
            const styles = { 'Favourable': 'bg-teal-100 text-teal-800 border-teal-200', 'Neutral': 'bg-slate-100 text-slate-600 border-slate-200', 'Unfavourable': 'bg-red-100 text-red-800 border-red-200' };
            return `<span class="text-[9px] font-bold px-1.5 py-0.5 rounded border ${styles[label]} uppercase tracking-wider mx-1">TIMING: ${label}</span>`;
        }

        function calculateFundamentalTiming(data) {
            if (data.type !== 'STOCK') return null;
            const profitGrowth = data.profitGrowth || 0; const pe = data.pe || 0; const r1y = data.returns?.r1y || 0;
            if (r1y > 100 || (pe > 60 && profitGrowth < 10) || profitGrowth < 0) return "Late";
            if ((profitGrowth > 15 && r1y < 5) || (pe > 0 && pe < 15 && profitGrowth > 5)) return "Early";
            if (profitGrowth > 5 && r1y >= 5 && r1y <= 80) return "Optimal";
            return r1y > 0 ? "Optimal" : "Early";
        }

        function getFundamentalTimingBadge(label) {
            if (!label) return '';
            const styles = { 'Early': 'bg-sky-100 text-sky-800 border-sky-200', 'Optimal': 'bg-lime-100 text-lime-800 border-lime-200', 'Late': 'bg-red-50 text-red-600 border-red-200' };
            return `<span class="text-[9px] font-bold px-1.5 py-0.5 rounded border ${styles[label]} uppercase tracking-wider mx-1">${label}</span>`;
        }

        function calculateTrajectoryScore(data) {
            if (data.type !== 'STOCK') return 0;
            const sales3Y = data.growth || 0; const profit3Y = data.profitGrowth || 0; const roe = data.roe || 0; const roce = data.roce || 0; const r3y = data.returns?.r3y || 0; const r5y = data.returns?.r5y || 0;
            let score = 0;
            if (sales3Y > 10 && profit3Y > 10) score += 5;
            if (profit3Y > sales3Y && sales3Y > 0) score += 5;
            if (roe > 15 && roce > 15) score += 5;
            if (r3y > 12 && r5y > 12) score += 5;
            return score;
        }

        function calculateRelativeStrength(data) {
            if (data.type !== 'STOCK') return 0;
            const roe = data.roe || 0; const roce = data.roce || 0; const profitGrowth = data.profitGrowth || 0; const opm = data.opm || 0; const name = data.name || "";
            const isFinancial = (roce < 12 && roe > 15) || (name.toUpperCase().includes("FINANCE") || name.toUpperCase().includes("BANK") || name.toUpperCase().includes("CAPITAL"));
            let medianEfficiency = isFinancial ? 13 : 15; let medianGrowth = isFinancial ? 12 : 10; let medianMargin = isFinancial ? 0 : 14;
            let score = 0;
            const efficiencyMetric = isFinancial ? roe : roce;
            if (efficiencyMetric > medianEfficiency * 1.2) score += 5; else if (efficiencyMetric > medianEfficiency) score += 2; else if (efficiencyMetric < medianEfficiency * 0.8) score -= 5; else score -= 2;
            if (isFinancial) { if (profitGrowth > medianGrowth * 1.2) score += 5; else if (profitGrowth > medianGrowth) score += 2; else if (profitGrowth < medianGrowth * 0.8) score -= 5; else score -= 2; } 
            else { let subScore = 0; if (profitGrowth > medianGrowth) subScore += 2.5; else subScore -= 2.5; if (opm > medianMargin) subScore += 2.5; else subScore -= 2.5; score += Math.round(subScore); }
            return Math.max(-10, Math.min(10, score));
        }

        function calculateFinalDecision(conviction, trajectory, timing, type, isHeld) {
            let action = isHeld ? "HOLD" : "WAIT";
            let summary = "";
            const isFund = type !== 'STOCK';
            const effTrajectory = isFund ? (timing === 'Favourable' ? 'Improving' : 'Flat') : trajectory;

            if (conviction === 'Weak') {
                if (isHeld) { action = "EXIT"; summary = "Fundamental thesis has deteriorated significantly. Risks outweigh rewards."; } 
                else { action = "AVOID"; summary = "Quality does not meet the threshold for investment. Look elsewhere."; }
            }
            else if (conviction === 'Strong') {
                if (effTrajectory === 'Deteriorating') {
                    if (isHeld) { action = "REVIEW"; summary = "Fundamentals are strong but momentum is fading. Watch closely."; } 
                    else { action = "WAIT"; summary = "Great company, but business momentum is slowing. Wait for stabilization."; }
                } else if (timing === 'Late') {
                    if (isHeld) { action = "HOLD"; summary = "Expensive, but quality is high. Ride the trend, but don't add aggressively."; } 
                    else { action = "WAIT"; summary = "Fundamentals are great, but the price is extended. Wait for a dip."; }
                } else {
                    if (isHeld) { action = "ADD"; summary = "Everything aligns: Quality, Growth, and Trend. Good level to increase allocation."; } 
                    else { action = "BUY NOW"; summary = "Prime setup: High conviction matched with accelerating business performance."; }
                }
            }
            else { 
                if (effTrajectory === 'Deteriorating') {
                    if (isHeld) action = "REDUCE"; else action = "AVOID";
                    summary = "Business stability is threatened by slowing growth trends.";
                } else if (timing === 'Unfavourable') {
                    if (isHeld) { action = "HOLD"; summary = "Price is weak, but business is stable. No urgency to exit yet."; } 
                    else { action = "WAIT"; summary = "Stable business, but negative price trend. Wait for support."; }
                } else {
                    if (isHeld) { action = "HOLD"; summary = "A steady performer. Continue holding for consistent compounding."; } 
                    else { action = "SIP ONLY"; summary = "Decent stability warrants a small, staggered allocation approach."; }
                }
            }
            return { action, summary };
        }

        function getDecisionBlock(decision, confidence) {
            const colors = { 'BUY NOW': 'bg-green-50 border-green-200 text-green-800', 'ADD': 'bg-emerald-50 border-emerald-200 text-emerald-800', 'SIP ONLY': 'bg-blue-50 border-blue-200 text-blue-800', 'HOLD': 'bg-indigo-50 border-indigo-200 text-indigo-800', 'WAIT': 'bg-orange-50 border-orange-200 text-orange-800', 'REVIEW': 'bg-yellow-50 border-yellow-200 text-yellow-800', 'REDUCE': 'bg-amber-50 border-amber-200 text-amber-800', 'EXIT': 'bg-red-50 border-red-200 text-red-800', 'AVOID': 'bg-slate-50 border-slate-200 text-slate-600' };
            const colorClass = colors[decision.action] || 'bg-gray-50 border-gray-200';
            
            // Confidence Style
            const confColors = { 'High': 'text-green-600', 'Medium': 'text-yellow-600', 'Low': 'text-red-600' };
            const confColor = confColors[confidence] || 'text-gray-400';

            return `<div class="mt-3 pt-3 border-t border-dashed border-gray-200">
                <div class="flex items-center justify-between mb-1">
                    <div class="flex items-center gap-2">
                        <span class="text-[9px] font-bold text-gray-400 uppercase tracking-widest">Final Verdict</span>
                        <span class="text-[8px] font-mono ${confColor}" title="Data Confidence">(${confidence} Conf.)</span>
                    </div>
                    <span class="text-[10px] font-bold px-2 py-0.5 rounded border ${colorClass}">${decision.action}</span>
                </div>
                <p class="text-[10px] text-gray-500 italic leading-relaxed">"${decision.summary}"</p>
            </div>`;
        }

        function calculateScoreActionMapper(score, timing, conviction, isHeld) {
            let strength = "Moderate";
            if (score >= 65) strength = "Strong"; else if (score <= 40) strength = "Weak";
            let s1 = `The fundamentals are ${strength.toLowerCase()} and the timing appears ${timing ? timing.toLowerCase() : 'neutral'}.`;
            let s2 = "", s3 = "";
            if (strength === "Strong") {
                if (timing === "Optimal" || timing === "Early") { s2 = "This alignment suggests high conviction with a supportive entry price."; s3 = isHeld ? "Consider adding to this winning position." : "It is a prime setup to deploy capital aggressively."; } 
                else { s2 = "However, the price has extended far beyond the ideal entry zone."; s3 = isHeld ? "Hold and ride the trend, but avoid fresh aggressive buying." : "Wait for a meaningful correction to improve the safety margin."; }
            } else if (strength === "Moderate") {
                if (timing === "Optimal") { s2 = "While not exceptional, the valuation offers a decent safety net."; s3 = isHeld ? "Keep holding, but monitor for better opportunities." : "A small, staggered allocation is appropriate here."; } 
                else { s2 = "Lacking both superior quality and perfect timing, the edge is thin."; s3 = isHeld ? "Review position size; upsides may be capped." : "It is better to remain on the sidelines for now."; }
            } else { 
                s2 = "The core business metrics do not support a long-term investment case."; s3 = "Capital preservation is priority; " + (isHeld ? "plan an exit strategy." : "avoid this counter.");
            }
            return `${s1} ${s2} ${s3}`;
        }

        function calculateMoreshwarLevels(price, fScore, pScore, isHolding) {
            const scoreSum = pScore ? (fScore.total + pScore.total) : fScore.total;
            const count = pScore ? 2 : 1;
            const X = Math.round(scoreSum / count); 
            const Y = price;
            let result = { target: null, sl: null, entry: null };
            if (isHolding) { result.target = Y + X; result.sl = Y - (100 - X); } 
            else { const offset = 100 - X; result.entry = Y - offset; }
            return result;
        }

        function getMoreshwarBlock(price, fScore, pScore, isHolding, decisionAction) {
            const showFor = ['BUY NOW', 'SIP ONLY', 'ADD', 'AVOID', 'WAIT'];
            if (!isHolding && !showFor.includes(decisionAction)) return '';
            const levels = calculateMoreshwarLevels(price, fScore, pScore, isHolding);
            let html = `<div class="mt-2 pt-2 border-t border-gray-100 flex justify-between items-center text-[10px] font-mono text-gray-600 bg-gray-50/50 p-2 rounded">`;
            if (isHolding) { html += `<div class="flex flex-col"><span class="text-[8px] text-gray-400 uppercase">Target (Y+X)</span><span class="font-bold text-green-600">₹${levels.target.toLocaleString()}</span></div><div class="flex flex-col text-right"><span class="text-[8px] text-gray-400 uppercase">Stop-loss (Price-Risk)</span><span class="font-bold text-red-600">₹${levels.sl.toLocaleString()}</span></div>`; } 
            else { 
                let label = "Entry Price"; let valColor = "text-blue-600";
                if (decisionAction === 'AVOID' || decisionAction === 'WAIT') { label = "Avoid Till"; valColor = "text-orange-500"; }
                html += `<div class="flex flex-col w-full text-center"><span class="text-[8px] text-gray-400 uppercase">${label}</span><span class="font-bold ${valColor}">₹${levels.entry.toLocaleString()}</span></div>`; 
            }
            html += `</div>`;
            return html;
        }

        // --- EXTENSION MODULE: SCORE NORMALIZATION ENGINE ---
        function calculateNormalizedScore(rawScore) {
            // Raw score can exceed 100 (e.g. 100 fund + 20 traj + 10 RS = 130)
            // Logic: Linear up to 60, then logarithmic curve to soft-cap near 99
            
            if (rawScore <= 60) return Math.max(0, rawScore);
            
            // For inputs > 60, map to 60-99
            // Formula: 60 + (MaxAdd * (1 - e^(-rate * (raw - 60))))
            // Using MaxAdd = 39 (to cap at 99), Rate optimized for spread
            
            const excess = rawScore - 60;
            const normalizedExcess = 39 * (1 - Math.exp(-0.035 * excess));
            
            return Math.round(60 + normalizedExcess);
        }
        
        function calculateDataConfidence(data) {
            let score = 3; // 3=High, 2=Medium, 1=Low

            // 1. Data Completeness
            if (data.type === 'STOCK') {
                if (data.source === 'Google') score -= 2; // Google data is very limited for stocks
                else {
                    if (!data.profitGrowth && !data.growth) score--; // Missing growth metrics
                    if (!data.roe && !data.roce) score--; // Missing return metrics
                }
                if (!data.returns?.r3y) score--; // Short history (IPO?)
            } else {
                // Funds
                if (!data.returns?.r3y || !data.returns?.r5y) score--;
            }

            // 2. Consistency Checks
            // Example: Price doubling but profit halving
            const r1y = data.returns?.r1y || 0;
            const profitGrowth = data.profitGrowth || 0;
            if (r1y > 100 && profitGrowth < -20) score--; 

            if (score >= 3) return "High";
            if (score === 2) return "Medium";
            return "Low";
        }
        
        function getDisplayName(sym) {
            return stockAnalysis[sym]?.name || cleanTicker(sym);
        }

        // Ensure initApp is available globally
        document.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>
